# -- Keycloak runtime image --
FROM quay.io/keycloak/keycloak:24.0.4

ENV KC_HEALTH_ENABLED=true

# üé® zkop√≠ruj core-material custom theme (funguj√≠c√≠ verze)
COPY themes/core-material/ /opt/keycloak/themes/core-material/

# üèóÔ∏è ADMIN REALM: zkop√≠ruj admin realm konfiguraci pro automatick√Ω import
COPY docker/keycloak/realm-admin.json /opt/keycloak/data/import/

# üîí SSL CERTIFICATES: zkop√≠ruj SSL certifik√°ty
COPY ssl/ /opt/keycloak/conf/

# üîß INIT SCRIPTS: zkop√≠ruj init scripty pro realm management
COPY docker/keycloak/init-realm.sh /opt/keycloak/
COPY docker/keycloak/entrypoint.sh /opt/keycloak/

# üîß SSL PERMISSIONS: nastav spr√°vn√° opr√°vnƒõn√≠ pro SSL certifik√°ty a scripty
USER root
RUN chmod 644 /opt/keycloak/conf/cert.pem && \
  chmod 600 /opt/keycloak/conf/key.pem && \
  chown keycloak:root /opt/keycloak/conf/cert.pem && \
  chown keycloak:root /opt/keycloak/conf/key.pem && \
  mkdir -p /opt/keycloak/data/import && \
  chown -R keycloak:root /opt/keycloak/data && \
  chmod +x /opt/keycloak/init-realm.sh && \
  chmod +x /opt/keycloak/entrypoint.sh
USER keycloak

# sestav KC distribuci
RUN /opt/keycloak/bin/kc.sh build --db=postgres

# ÔøΩ Custom entrypoint s realm init
ENTRYPOINT ["/opt/keycloak/entrypoint.sh"]