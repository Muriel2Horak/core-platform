[server]
protocol = http
http_port = 3000
# CRITICAL: Use %(domain)s variable - Grafana reads from Host header
# This supports multi-tenant setup (admin.*, tenant1.*, tenant2.*, etc.)
# DO NOT hardcode "admin." - it would cause admin.admin.core-platform.local redirects
root_url = https://%(domain)s/core-admin/monitoring
# CRITICAL: serve_from_sub_path MUST be true when root_url contains subpath
# NGINX forwards full path /core-admin/monitoring/* to Grafana
serve_from_sub_path = true

[security]
allow_embedding = true
cookie_secure = true
cookie_samesite = none
content_security_policy = true

[auth.jwt]
enabled = true
header_name = X-Org-JWT
username_claim = preferred_username
email_claim = email
expect_claims = {}
# RS256 validation via JWKS from BFF (via Docker network, NOT public domain)
# CRITICAL: Must use internal Docker service name 'backend', not public domain
# Public domain would resolve to 127.0.0.1 inside container (connection refused)
key_file =
jwk_set_url = http://backend:8080/.well-known/jwks.json
cache_ttl = 60m
auto_sign_up = true
# Role mapping from Keycloak realm_access.roles
role_attribute_path = contains(realm_access.roles[*], 'CORE_ROLE_ADMIN') && 'Admin' || contains(realm_access.roles[*], 'CORE_ROLE_MONITORING') && 'Editor' || 'Viewer'
skip_org_role_sync = false

[auth]
# CRITICAL: Disable login form when using JWT SSO
disable_login_form = true
oauth_auto_login = false

[auth.generic_oauth]
enabled = true
name = Keycloak
allow_sign_up = true
client_id = grafana
client_secret = grafana-secret-change-in-prod
scopes = openid profile email
auth_url = https://admin.core-platform.local/realms/admin/protocol/openid-connect/auth
token_url = https://keycloak:8443/realms/admin/protocol/openid-connect/token
api_url = https://keycloak:8443/realms/admin/protocol/openid-connect/userinfo
role_attribute_path = contains(realm_access.roles[*], 'CORE_ROLE_ADMIN') && 'Admin' || contains(realm_access.roles[*], 'CORE_ROLE_MONITORING') && 'Editor' || 'Viewer'
tls_skip_verify_insecure = true
use_pkce = true

[users]
auto_assign_org = true
auto_assign_org_role = Viewer
viewers_can_edit = false
editors_can_admin = false

[log]
mode = console
level = info
