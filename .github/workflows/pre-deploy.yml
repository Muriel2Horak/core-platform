name: Pre-Deploy E2E Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  pre-deploy-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'e2e/package-lock.json'
      
      - name: Install E2E dependencies
        working-directory: ./e2e
        run: |
          npm ci
          npx playwright install --with-deps chromium
      
      - name: Run PRE-DEPLOY smoke tests
        working-directory: ./e2e
        env:
          PRE_BASE_URL: ${{ secrets.PRE_BASE_URL || 'https://core-platform.local' }}
          E2E_IGNORE_TLS: ${{ secrets.E2E_IGNORE_TLS || 'false' }}
          E2E_USER: test
          E2E_PASS: Test.1234
        run: |
          npx playwright test --project=pre --reporter=html,json
      
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre-deploy-playwright-report
          path: e2e/playwright-report/
          retention-days: 7
      
      - name: Upload traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pre-deploy-playwright-traces
          path: e2e/test-results/**/*.zip
          retention-days: 7
      
      - name: Comment PR with report
        if: github.event_name == 'pull_request' && always()
        uses: daun/playwright-report-summary@v3
        with:
          report-file: e2e/playwright-report/results.json
          comment-title: 'ðŸ§ª Pre-Deploy E2E Test Results'
      
      - name: Generate COPILOT hints on failure
        if: failure()
        run: |
          echo "##[COPILOT_START_JSON]"
          cat <<EOF
          {
            "suite": "pre-deploy",
            "env": "${{ secrets.PRE_BASE_URL || 'https://core-platform.local' }}",
            "failedTests": [],
            "suspectedCauses": [
              "Keycloak not running or unreachable",
              "Base URL incorrect or TLS certificate issues",
              "Test user credentials invalid"
            ],
            "recommendedFixes": [
              {
                "title": "Check local environment",
                "steps": [
                  "Verify docker-compose services are running: docker ps",
                  "Check Keycloak is accessible: curl -k https://core-platform.local/auth",
                  "Verify test user exists in Keycloak admin console"
                ]
              },
              {
                "title": "TLS certificate issues",
                "files": ["ssl/"],
                "steps": [
                  "Set E2E_IGNORE_TLS=true in GitHub secrets",
                  "Or fix SSL certificates in ssl/ directory"
                ]
              }
            ]
          }
          EOF
          echo "##[COPILOT_END_JSON]"
          echo "COPILOT_HINT: Check if https://core-platform.local is accessible from CI runner"
          echo "COPILOT_HINT: Verify E2E_USER and E2E_PASS secrets are set correctly"
