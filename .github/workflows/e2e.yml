name: E2E Tests (Local Environment)

# Tento workflow vy≈æaduje self-hosted runner s bƒõ≈æ√≠c√≠m https://core-platform.local
# GitHub-hosted runners NEMOHOU bƒõ≈æet tyto testy (nemaj√≠ lok√°ln√≠ prost≈ôed√≠)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Ruƒçn√≠ spu≈°tƒõn√≠

jobs:
  e2e-tests:
    name: E2E Tests
    # D≈ÆLE≈ΩIT√â: Mus√≠ bƒõ≈æet na self-hosted runneru s lok√°ln√≠m prost≈ôed√≠m
    runs-on: self-hosted
    
    # Pouze pokud self-hosted runner existuje
    # if: ${{ vars.HAS_SELF_HOSTED_RUNNER == 'true' }}
    
    defaults:
      run:
        working-directory: frontend
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Verify local environment is running
        run: |
          echo "üîç Checking https://core-platform.local is accessible..."
          curl -k -f -s https://core-platform.local > /dev/null || {
            echo "‚ùå Local environment is NOT running!"
            echo "Please start it with: make clean"
            exit 1
          }
          echo "‚úÖ Local environment is running"
      
      - name: Run E2E tests
        run: npm run test:e2e
        env:
          # Ignoruj TLS pokud runner nem√° trusted cert
          E2E_IGNORE_TLS: 'true'
          # Base URL (default je https://core-platform.local)
          # E2E_BASE_URL: 'https://core-platform.local'
      
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: test-results
          path: frontend/test-results/
          retention-days: 7
      
      - name: Upload traces
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-traces
          path: frontend/test-results/**/*.zip
          retention-days: 7
      
      - name: Comment PR with report
        if: github.event_name == 'pull_request' && always()
        uses: daun/playwright-report-summary@v3
        with:
          report-file: frontend/playwright-report/results.json
          comment-title: 'üß™ E2E Test Results'
