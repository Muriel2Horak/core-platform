name: AI Preflight Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ai-preflight-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ai-schema-validation:
    name: Validate AI Schema
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Validate AI schema classes
        working-directory: backend
        run: |
          echo "ğŸ” Validating AI schema classes..."
          ./mvnw test -Dtest=AiSchemaValidatorTest
          echo "âœ… AI schema validation passed"

      - name: Validate metamodel AI configuration
        working-directory: backend
        run: |
          echo "ğŸ” Checking metamodel YAML files for AI configuration..."
          
          # Check if global-config.yaml has AI section
          if grep -q "^ai:" src/main/resources/metamodel/global-config.yaml; then
            echo "âœ… global-config.yaml has AI section"
          else
            echo "âš ï¸ Warning: global-config.yaml missing AI section"
          fi
          
          # Count entity YAML files with AI configuration
          AI_ENTITIES=$(grep -l "^ai:" src/main/resources/metamodel/*.yaml 2>/dev/null || echo "")
          if [ -n "$AI_ENTITIES" ]; then
            echo "âœ… Found entity YAML files with AI configuration:"
            echo "$AI_ENTITIES"
          else
            echo "â„¹ï¸ No entity YAML files with AI configuration found (optional)"
          fi

  ai-endpoints-smoke:
    name: AI Endpoints Smoke Test
    runs-on: ubuntu-latest
    needs: ai-schema-validation
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build backend
        working-directory: backend
        run: |
          echo "ğŸ”¨ Building backend..."
          ./mvnw clean package -DskipTests
          echo "âœ… Backend built"

      - name: Start backend
        working-directory: backend
        run: |
          echo "ğŸš€ Starting backend..."
          java -jar target/*.jar --spring.profiles.active=test &
          BACKEND_PID=$!
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
          echo "âœ… Backend started (PID: $BACKEND_PID)"

      - name: Wait for backend readiness
        run: |
          echo "â³ Waiting for backend to be ready..."
          for i in {1..30}; do
            if curl -sf http://localhost:8080/actuator/health >/dev/null 2>&1; then
              echo "âœ… Backend is ready";
              break;
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Backend not ready in time"
              exit 1
            fi
            echo "â³ Waiting... ($i/30)"
            sleep 2
          done

      - name: Test AI context endpoint
        run: |
          echo "ğŸ§ª Testing /api/ai/context endpoint..."
          
          # Test with AI disabled (should return 404)
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/ai/context?routeId=test.route)
          
          if [ "$RESPONSE" = "404" ]; then
            echo "âœ… AI context endpoint returns 404 when disabled (expected)"
          elif [ "$RESPONSE" = "200" ]; then
            echo "âš ï¸ AI is enabled, testing META_ONLY mode..."
            
            # Fetch actual response
            CONTEXT=$(curl -s http://localhost:8080/api/ai/context?routeId=users.list)
            
            # Check for prohibited fields
            if echo "$CONTEXT" | grep -q '"value"\s*:'; then
              echo "âŒ FAIL: Found 'value' field in response (META_ONLY violation)"
              echo "$CONTEXT" | jq .
              exit 1
            fi
            
            if echo "$CONTEXT" | grep -qE '"rows"\s*:\s*\[(?!\s*\])'; then
              echo "âŒ FAIL: Found 'rows' with data in response (META_ONLY violation)"
              echo "$CONTEXT" | jq .
              exit 1
            fi
            
            echo "âœ… META_ONLY mode verified (no data values)"
          else
            echo "âš ï¸ Unexpected response: $RESPONSE"
          fi

      - name: Test MCP endpoints
        run: |
          echo "ğŸ§ª Testing MCP endpoints..."
          
          # Test ui_context
          UI_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/ai/mcp/ui_context/get_current_view \
            -H "Content-Type: application/json" \
            -d '{"routeId": "test.route"}')
          echo "ğŸ“Š ui_context response: $UI_RESPONSE"
          
          # Test wf_context
          WF_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/ai/mcp/wf_context/get_workflow \
            -H "Content-Type: application/json" \
            -d '{"entity": "test"}')
          echo "âš¡ wf_context response: $WF_RESPONSE"
          
          # Test data_context (should be 501)
          DATA_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/ai/mcp/data_context/query \
            -H "Content-Type: application/json" \
            -d '{"entity": "test"}')
          
          if [ "$DATA_RESPONSE" = "501" ]; then
            echo "âœ… data_context correctly returns 501 NOT_IMPLEMENTED"
          else
            echo "âŒ data_context should return 501, got: $DATA_RESPONSE"
            exit 1
          fi

      - name: Test AI metrics
        run: |
          echo "ğŸ“Š Testing AI metrics..."
          
          METRICS=$(curl -s http://localhost:8080/actuator/prometheus)
          
          # Check if AI metrics are registered
          if echo "$METRICS" | grep -q "ai_requests_total"; then
            echo "âœ… Found ai_requests_total metric"
          else
            echo "â„¹ï¸ ai_requests_total metric not found (may not be used yet)"
          fi
          
          if echo "$METRICS" | grep -q "mcp_calls_total"; then
            echo "âœ… Found mcp_calls_total metric"
          else
            echo "â„¹ï¸ mcp_calls_total metric not found (may not be used yet)"
          fi

      - name: Stop backend
        if: always()
        run: |
          if [ -n "$BACKEND_PID" ]; then
            echo "ğŸ›‘ Stopping backend (PID: $BACKEND_PID)..."
            kill $BACKEND_PID || true
            echo "âœ… Backend stopped"
          fi

  ai-grafana-dashboards:
    name: Validate Grafana Dashboards
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check AI dashboards exist
        run: |
          echo "ğŸ” Checking Grafana AI dashboards..."
          
          if [ -f "docker/grafana/provisioning/dashboards/ai-overview.json" ]; then
            echo "âœ… ai-overview.json exists"
          else
            echo "âŒ ai-overview.json not found"
            exit 1
          fi
          
          if [ -f "docker/grafana/provisioning/dashboards/ai-ops.json" ]; then
            echo "âœ… ai-ops.json exists"
          else
            echo "âŒ ai-ops.json not found"
            exit 1
          fi

      - name: Validate dashboard JSON
        run: |
          echo "ğŸ” Validating dashboard JSON syntax..."
          
          if jq empty docker/grafana/provisioning/dashboards/ai-overview.json 2>/dev/null; then
            echo "âœ… ai-overview.json is valid JSON"
          else
            echo "âŒ ai-overview.json is invalid JSON"
            exit 1
          fi
          
          if jq empty docker/grafana/provisioning/dashboards/ai-ops.json 2>/dev/null; then
            echo "âœ… ai-ops.json is valid JSON"
          else
            echo "âŒ ai-ops.json is invalid JSON"
            exit 1
          fi

      - name: Check dashboard contains AI metrics
        run: |
          echo "ğŸ” Checking dashboard contains AI metrics..."
          
          # Check ai-overview.json
          if grep -q "ai_requests_total" docker/grafana/provisioning/dashboards/ai-overview.json; then
            echo "âœ… ai-overview.json contains ai_requests_total"
          else
            echo "âš ï¸ ai-overview.json missing ai_requests_total"
          fi
          
          # Check ai-ops.json
          if grep -q "mcp_calls_total" docker/grafana/provisioning/dashboards/ai-ops.json; then
            echo "âœ… ai-ops.json contains mcp_calls_total"
          else
            echo "âš ï¸ ai-ops.json missing mcp_calls_total"
          fi

  ai-integration-tests:
    name: Run AI Integration Tests
    runs-on: ubuntu-latest
    needs: ai-schema-validation
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run AI integration tests
        working-directory: backend
        run: |
          echo "ğŸ§ª Running AI integration tests..."
          ./mvnw test -Dtest=*Ai*IT
          echo "âœ… AI integration tests passed"

  summary:
    name: AI Preflight Summary
    runs-on: ubuntu-latest
    needs: [ai-schema-validation, ai-endpoints-smoke, ai-grafana-dashboards, ai-integration-tests]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "ğŸ“Š AI Preflight Checks Summary"
          echo "=============================="
          echo "âœ… AI Schema Validation: ${{ needs.ai-schema-validation.result }}"
          echo "âœ… AI Endpoints Smoke: ${{ needs.ai-endpoints-smoke.result }}"
          echo "âœ… Grafana Dashboards: ${{ needs.ai-grafana-dashboards.result }}"
          echo "âœ… Integration Tests: ${{ needs.ai-integration-tests.result }}"
          
          if [ "${{ needs.ai-schema-validation.result }}" = "success" ] && \
             [ "${{ needs.ai-endpoints-smoke.result }}" = "success" ] && \
             [ "${{ needs.ai-grafana-dashboards.result }}" = "success" ] && \
             [ "${{ needs.ai-integration-tests.result }}" = "success" ]; then
            echo "âœ… All AI preflight checks passed!"
            exit 0
          else
            echo "âŒ Some AI preflight checks failed"
            exit 1
          fi
