name: Post-Deploy E2E Tests

on:
  workflow_run:
    workflows: ["Deploy"]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  post-deploy-e2e:
    runs-on: self-hosted
    timeout-minutes: 30
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'e2e/package-lock.json'
      
      - name: Install E2E dependencies
        working-directory: ./e2e
        run: |
          npm ci
          npx playwright install --with-deps chromium
      
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "env=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "env=staging" >> $GITHUB_OUTPUT
          fi
      
      - name: Run scaffold script
        working-directory: ./e2e
        env:
          POST_BASE_URL: ${{ secrets[format('{0}_BASE_URL', steps.env.outputs.env)] }}
          E2E_ADMIN_USER: test_admin
          E2E_ADMIN_PASS: Test.1234
          E2E_IGNORE_TLS: ${{ secrets.E2E_IGNORE_TLS || 'false' }}
        run: |
          node scripts/scaffold.ts --env POST
      
      - name: Run POST-DEPLOY E2E tests
        working-directory: ./e2e
        env:
          POST_BASE_URL: ${{ secrets[format('{0}_BASE_URL', steps.env.outputs.env)] }}
          E2E_IGNORE_TLS: ${{ secrets.E2E_IGNORE_TLS || 'false' }}
        run: |
          npx playwright test --project=post --reporter=html,json
      
      - name: Run teardown script
        if: always()
        working-directory: ./e2e
        env:
          POST_BASE_URL: ${{ secrets[format('{0}_BASE_URL', steps.env.outputs.env)] }}
          E2E_ADMIN_USER: test_admin
          E2E_ADMIN_PASS: Test.1234
        run: |
          node scripts/teardown.ts --env POST
      
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: post-deploy-playwright-report-${{ steps.env.outputs.env }}
          path: e2e/playwright-report/
          retention-days: 14
      
      - name: Upload traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: post-deploy-playwright-traces-${{ steps.env.outputs.env }}
          path: e2e/test-results/**/*.zip
          retention-days: 14
      
      - name: Upload scaffold artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: post-deploy-scaffold-result-${{ steps.env.outputs.env }}
          path: e2e/.auth/scaffold-result.json
          retention-days: 7
      
      - name: Generate E2E summary with COPILOT hints
        if: always()
        run: |
          echo "##[COPILOT_START_JSON]"
          cat <<EOF
          {
            "suite": "post-deploy",
            "env": "${{ secrets[format('{0}_BASE_URL', steps.env.outputs.env)] }}",
            "environment": "${{ steps.env.outputs.env }}",
            "failedTests": [],
            "suspectedCauses": [],
            "recommendedFixes": [
              {
                "title": "Keycloak redirect mismatch",
                "files": ["keycloak/realm-export.json", "frontend/src/config/keycloak.json"],
                "steps": [
                  "Update redirect URIs in Keycloak realm config to match ${{ steps.env.outputs.env }} URL",
                  "Add https://${{ steps.env.outputs.env }}.core-platform.company/* to valid redirect URIs",
                  "Redeploy Keycloak configuration"
                ]
              },
              {
                "title": "Workflow Circuit Breaker open",
                "files": ["backend/src/main/resources/application-prod.yml"],
                "steps": [
                  "Lower resilience4j.circuitbreaker.instances.*.failureRateThreshold to 50",
                  "Increase resilience4j.timelimiter.instances.*.timeout to 5s",
                  "Check backend logs for upstream service failures"
                ]
              },
              {
                "title": "MinIO connection issues",
                "files": ["k8s/base/minio-config.yml"],
                "steps": [
                  "Verify MinIO endpoint is reachable from backend pods",
                  "Check MinIO credentials in secret",
                  "Verify bucket exists and has correct permissions"
                ]
              }
            ]
          }
          EOF
          echo "##[COPILOT_END_JSON]"
          echo ""
          echo "COPILOT_HINT: Check Loki logs for backend errors: kubectl logs -l app=backend --tail=500"
          echo "COPILOT_HINT: Verify Kafka topics exist: kubectl exec -it kafka-0 -- kafka-topics.sh --list --bootstrap-server localhost:9092"
          echo "COPILOT_HINT: Check ArgoCD sync status: kubectl get applications -n argocd"
          echo "COPILOT_HINT: Review Grafana dashboards for service health metrics"
