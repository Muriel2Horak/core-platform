name: Smoke Test (Build Doctor)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  smoke:
    name: Local PROD-like Smoke Test
    runs-on: self-hosted
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
      
      - name: Run Build Doctor - Rebuild
        run: |
          make rebuild
        continue-on-error: true
      
      - name: Upload diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-doctor-diagnostics-${{ github.run_number }}
          path: |
            diagnostics/*.log
            diagnostics/*.json
            .tmp/*.json
          retention-days: 7
          if-no-files-found: warn
      
      - name: Check build status
        run: |
          if [ -f "diagnostics/build-report-*.json" ]; then
            echo "üìä Build Report:"
            cat diagnostics/build-report-*.json | jq '.'
            
            STATUS=$(cat diagnostics/build-report-*.json | jq -r '.status')
            
            if [ "$STATUS" = "FAILED" ]; then
              echo "‚ùå Build failed - check diagnostics artifact"
              exit 1
            fi
          fi
          
          echo "‚úÖ Build succeeded"
