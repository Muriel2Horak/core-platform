name: Monitoring - Grafana Provisioning

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docker/grafana/provisioning/**'
      - 'backend/src/main/java/cz/muriel/core/monitoring/grafana/**'
      - 'scripts/test-grafana-provisioning.sh'
      - 'scripts/validate-dashboard-structure.sh'
  pull_request:
    paths:
      - 'docker/grafana/provisioning/**'
      - 'backend/src/main/java/cz/muriel/core/monitoring/grafana/**'
  workflow_dispatch:

jobs:
  validate-structure:
    name: Validate Dashboard Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Validate dashboard file structure
        run: |
          bash scripts/validate-dashboard-structure.sh
      
      - name: Check for loose JSON files
        run: |
          LOOSE_FILES=$(find docker/grafana/provisioning/dashboards -maxdepth 1 -name "*.json" -type f 2>/dev/null || true)
          if [[ -n "$LOOSE_FILES" ]]; then
            echo "‚ùå ERROR: Found loose JSON files in root directory:"
            echo "$LOOSE_FILES"
            echo ""
            echo "Dashboard JSON files must be in subdirectories:"
            echo "  - docker/grafana/provisioning/dashboards/custom/"
            echo "  - docker/grafana/provisioning/dashboards/system/"
            echo "  - docker/grafana/provisioning/dashboards/advanced/"
            echo "  - docker/grafana/provisioning/dashboards/streaming/"
            echo "  - docker/grafana/provisioning/dashboards/security/"
            echo "  - docker/grafana/provisioning/dashboards/audit/"
            echo "  - docker/grafana/provisioning/dashboards/monitoring-bff/"
            exit 1
          fi
          echo "‚úÖ No loose JSON files found"

  runtime-tests:
    name: Runtime Provisioning Tests
    runs-on: ubuntu-latest
    needs: validate-structure
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Create .env file
        run: |
          cat > .env <<EOF
          # CI Environment
          COMPOSE_PROJECT_NAME=core-ci
          CORE_ENV=ci
          
          # Monitoring
          GRAFANA_ADMIN_USER=admin
          GRAFANA_ADMIN_PASSWORD=admin
          LOKI_URL=http://loki:3100
          
          # Minimal config for Grafana smoke test
          DB_HOST=localhost
          DB_PORT=5432
          EOF
      
      - name: Start Grafana
        run: |
          docker compose -f docker/docker-compose.yml up -d grafana loki
          
          # Wait for Grafana to be ready
          for i in {1..30}; do
            if docker exec core-grafana curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "‚úÖ Grafana is ready"
              break
            fi
            echo "‚è≥ Waiting for Grafana to start... ($i/30)"
            sleep 2
          done
      
      - name: Check Grafana logs for errors
        run: |
          echo "üìã Checking Grafana logs for provisioning errors..."
          ERRORS=$(docker logs core-grafana 2>&1 | grep -i "error\|fail\|panic" | grep -v "context canceled" || true)
          
          if [[ -n "$ERRORS" ]]; then
            echo "‚ùå Found errors in Grafana logs:"
            echo "$ERRORS"
            exit 1
          fi
          
          echo "‚úÖ No critical errors in Grafana logs"
      
      - name: Run Grafana provisioning diagnostics
        run: |
          bash scripts/test-grafana-provisioning.sh
      
      - name: Verify dashboard UIDs are stable
        run: |
          echo "üîç Verifying dashboard UIDs follow naming convention..."
          
          # Check Axiom dashboards have stable UIDs
          AXIOM_UIDS=$(docker exec core-grafana curl -sf -u admin:admin \
            "http://localhost:3000/api/search?type=dash-db" | \
            jq -r '.[] | select(.uid | startswith("axiom_")) | .uid')
          
          EXPECTED_AXIOM_UIDS=(
            "axiom_sys_overview"
            "axiom_adv_db"
            "axiom_adv_redis"
            "axiom_adv_runtime"
            "axiom_kafka_lag"
            "axiom_security"
            "axiom_audit"
          )
          
          for uid in "${EXPECTED_AXIOM_UIDS[@]}"; do
            if ! echo "$AXIOM_UIDS" | grep -q "^$uid$"; then
              echo "‚ùå Missing expected UID: $uid"
              exit 1
            fi
          done
          
          echo "‚úÖ All Axiom dashboards have stable UIDs"
      
      - name: Upload Grafana logs
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: grafana-provisioning-logs-${{ github.run_number }}
          path: |
            grafana-logs.txt
          retention-days: 7
        continue-on-error: true
      
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down -v

  summary:
    name: Provisioning Tests Summary
    runs-on: ubuntu-latest
    needs: [validate-structure, runtime-tests]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          if [ "${{ needs.validate-structure.result }}" != "success" ] || \
             [ "${{ needs.runtime-tests.result }}" != "success" ]; then
            echo "‚ùå Grafana provisioning tests failed"
            echo ""
            echo "Common issues:"
            echo "1. Loose JSON files in root directory - move to subdirectories"
            echo "2. Missing folderUid in dashboard JSON - remove it"
            echo "3. Duplicate provisioning in backend - check for multiple GrafanaProvisioningService classes"
            echo "4. Invalid dashboard UIDs - use stable naming convention (axiom_*)"
            exit 1
          fi
          
          echo "‚úÖ All Grafana provisioning tests passed"
