# Dev Container Overlay for docker-compose.yml
# This file extends the base docker-compose.yml with development-specific settings
# Usage: docker compose -f docker/docker-compose.yml -f .devcontainer/docker-compose.devcontainer.yml up

services:
  # Frontend - Esbuild dev server (watch mode)
  frontend:
    build:
      context: ..                # ✅ OPRAVENO - build context je root projektu
      dockerfile: docker/frontend/Dockerfile.dev
      args:
        - NODE_ENV=development
    volumes:
      # Mount source code for live editing
      - ../frontend/src:/app/src
      - ../frontend/public:/app/public
      - ../frontend/index.html:/app/index.html
      - ../frontend/package.json:/app/package.json
      - ../frontend/tsconfig.json:/app/tsconfig.json
      # ✅ OPRAVENO - přidány esbuild soubory místo vite
      - ../frontend/esbuild.mjs:/app/esbuild.mjs
      - ../frontend/nginx.conf:/app/nginx.conf
      # Use named volume for node_modules to avoid conflicts
      - frontend-node-modules:/app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8080
      - VITE_KEYCLOAK_URL=http://localhost:8081
    # ✅ OPRAVENO - healthcheck pro vývojový režim (esbuild dev server na portu 8080)
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/bundle.js || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # ✅ OPRAVENO - expose port 8080 pro Nginx proxy
    ports:
      - "3000:8080"  # Pro přímý přístup z hosta (volitelné)
    # Watch mode pro automatický rebuild při změně
    develop:
      watch:
        - action: sync+restart
          path: ../frontend/src
          target: /app/src
        - action: rebuild
          path: ../frontend/package.json

  # ✅ NOVÉ - Nginx s vývojovou konfigurací
  nginx:
    volumes:
      # Override s vývojovou konfigurací (proxy na frontend:8080 místo frontend:80)
      - ../docker/nginx/nginx.dev.conf:/etc/nginx/conf.d/default.conf

  # Backend - Spring Boot with DevTools hot reload
  backend:
    env_file:
      - ../.env
    build:
      context: ..
      dockerfile: docker/backend/Dockerfile.dev
    volumes:
      # Mount entire source for Maven to compile
      - ../backend/src:/workspace/src
      - ../backend/pom.xml:/workspace/pom.xml
      - ../backend/mvnw:/workspace/mvnw
      - ../backend/mvnw.cmd:/workspace/mvnw.cmd
      - ../backend/.mvn:/workspace/.mvn
      # Maven cache for faster dependency resolution
      - maven-cache:/root/.m2
    command: ./mvnw spring-boot:run -Dspring-boot.run.jvmArguments="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
    environment:
      - SPRING_DEVTOOLS_RESTART_ENABLED=true
      - SPRING_PROFILES_ACTIVE=development
    ports:
      - "5005:5005"  # Java debug port
    working_dir: /workspace

  # Database - no changes needed, inherits from base
  db:
    profiles:
      - "" # Always active

  # Keycloak - no changes needed, inherits from base
  keycloak:
    profiles:
      - "" # Always active

volumes:
  maven-cache:
    driver: local
  frontend-node-modules:
    driver: local
