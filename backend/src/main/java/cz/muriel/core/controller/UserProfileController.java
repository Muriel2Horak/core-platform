package cz.muriel.core.controller;

import cz.muriel.core.dto.*;
import cz.muriel.core.auth.KeycloakAdminService;
import cz.muriel.core.service.S3StorageService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.Authentication;
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;

@Slf4j @RestController @RequestMapping("/api/me") @RequiredArgsConstructor @Validated
public class UserProfileController {

  private final KeycloakAdminService keycloakAdminService;
  private final S3StorageService s3StorageService;

  @GetMapping @PreAuthorize("isAuthenticated()")
  public ResponseEntity<UserDto> getMyProfile(Authentication authentication) {
    String username = getCurrentUsername(authentication);
    log.info("Getting profile for username: {}", username);

    // M√≠sto hled√°n√≠ podle ID pou≈æijeme username
    UserDto user = keycloakAdminService.getUserByUsername(username);

    // P≈ôidej spr√°vnou URL pro profilov√Ω obr√°zek
    enrichUserWithImageUrl(user);

    return ResponseEntity.ok(user);
  }

  /**
   * Speci√°ln√≠ endpoint pro naƒç√≠t√°n√≠ profilu po nahr√°n√≠ fotky s retry mechanismem
   */
  @GetMapping("/with-retry")
  @PreAuthorize("isAuthenticated()")
  public ResponseEntity<UserDto> getMyProfileWithRetry(
      @RequestParam(required = false, defaultValue = "customProfileImage") String expectedAttribute,
      @RequestParam(required = false, defaultValue = "3") int maxRetries,
      Authentication authentication) {
    
    String username = getCurrentUsername(authentication);
    log.info("üîÑ Getting profile with retry for username: {}, expecting attribute: {}", username, expectedAttribute);

    // Pou≈æij retry mechanismus pro ƒçerstvƒõ aktualizovan√© atributy
    UserDto user = keycloakAdminService.getUserByUsernameWithRetry(username, expectedAttribute, maxRetries);

    // P≈ôidej spr√°vnou URL pro profilov√Ω obr√°zek
    enrichUserWithImageUrl(user);

    return ResponseEntity.ok(user);
  }

  @PutMapping @PreAuthorize("isAuthenticated()")
  public ResponseEntity<UserDto> updateMyProfile(@Valid @RequestBody UserUpdateRequest request,
      Authentication authentication) {
    String username = getCurrentUsername(authentication);
    log.info("Updating profile for username: {}", username);

    // Nejd≈ô√≠ve najdeme u≈æivatele podle username, abychom z√≠skali jeho ID
    UserDto existingUser = keycloakAdminService.getUserByUsername(username);
    String userId = existingUser.getId();

    UserDto updatedUser = keycloakAdminService.updateUser(userId, request);

    // P≈ôidej spr√°vnou URL pro profilov√Ω obr√°zek
    enrichUserWithImageUrl(updatedUser);

    return ResponseEntity.ok(updatedUser);
  }

  @PutMapping("/password") @PreAuthorize("isAuthenticated()")
  public ResponseEntity<Void> changeMyPassword(@Valid @RequestBody PasswordChangeRequest request,
      Authentication authentication) {
    String username = getCurrentUsername(authentication);
    log.info("Changing password for username: {}", username);

    // Nejd≈ô√≠ve najdeme u≈æivatele podle username, abychom z√≠skali jeho ID
    UserDto existingUser = keycloakAdminService.getUserByUsername(username);
    String userId = existingUser.getId();

    // Validate that new password and confirmation match
    if (!request.getNewPassword().equals(request.getConfirmPassword())) {
      throw new IllegalArgumentException("Nov√© heslo a potvrzen√≠ se neshoduj√≠");
    }

    // Validate current password
    if (!keycloakAdminService.validateUserPassword(username, request.getCurrentPassword())) {
      throw new IllegalArgumentException("Souƒçasn√© heslo je nespr√°vn√©");
    }

    // Change password
    keycloakAdminService.changeUserPassword(userId, request.getNewPassword(), false);

    return ResponseEntity.ok().build();
  }

  /**
   * Obohacuje UserDto o spr√°vnou URL pro profilov√Ω obr√°zek
   */
  private void enrichUserWithImageUrl(UserDto user) {
    if (user != null) {
      log.info("üîç PROFIL: Enriching user {} with image URL", user.getUsername());

      String profilePictureKey = null;

      // üß™ TEST: Zkus naj√≠t customProfileImage m√≠sto profilePicture
      if (user.getCustomAttributes() != null) {
        log.info("üîç PROFIL: CustomAttributes map exists, size: {}",
            user.getCustomAttributes().size());
        log.info("üîç PROFIL: All customAttributes keys: {}", user.getCustomAttributes().keySet());

        profilePictureKey = user.getCustomAttributes().get("customProfileImage");
        log.info("üîç PROFIL: Found customProfileImage in customAttributes: {}", profilePictureKey);
      } else {
        log.info("üîç PROFIL: No customAttributes found for user: {}", user.getUsername());
      }

      // Fallback na p≈ô√≠m√© pole (pro zpƒõtnou kompatibilitu)
      if (profilePictureKey == null || profilePictureKey.isEmpty()) {
        profilePictureKey = user.getProfilePicture();
        log.info("üîç PROFIL: Using direct profilePicture field: {}", profilePictureKey);
      }

      if (profilePictureKey != null && !profilePictureKey.isEmpty()) {
        String imageUrl = s3StorageService.getFileUrl(profilePictureKey);
        user.setProfilePictureUrl(imageUrl);
        // Zajisti aby bylo nastaveno i p≈ô√≠m√© pole
        user.setProfilePicture(profilePictureKey);
        log.info("‚úÖ PROFIL: Generated profile picture URL for user {}: {} -> {}",
            user.getUsername(), profilePictureKey, imageUrl);
      } else {
        log.warn("‚ùå PROFIL: No profile picture found for user: {}", user.getUsername());
      }
    } else {
      log.warn("‚ùå PROFIL: User is null, cannot enrich with image URL");
    }
  }

  private String getCurrentUsername(Authentication authentication) {
    Jwt jwt = (Jwt) authentication.getPrincipal();
    return jwt.getClaimAsString("preferred_username");
  }
}
