# KOMPLETNÃ AUDIT: Secrets, Konfigurace, PromÄ›nnÃ© & Runtime

**Datum:** 27. Å™Ã­jna 2025  
**ÃšÄel:** MapovÃ¡nÃ­ VÅ ECH secrets, DB credentials, URLs, portÅ¯, SSL certifikÃ¡tÅ¯ a jejich tokÅ¯

---

## ğŸ“‹ EXECUTIVE SUMMARY

### KritickÃ© NÃ¡lezy
- ğŸ”´ **47 environment variables** v systÃ©mu
- ğŸ”´ **12 secrets/passwords** (databÃ¡ze, Keycloak, JWT, SSL)
- ğŸ”´ **6 rÅ¯znÃ½ch konfiguraÄnÃ­ch zdrojÅ¯** (.env, templates, application.yml, realm.json, nginx.conf)
- ğŸ”´ **3 substitution mechanismy** (envsubst, Spring ${}, Keycloak import)

### BezpeÄnostnÃ­ Rizika
- âš ï¸ `.env` obsahuje plain-text secrets (nenÃ­ v `.gitignore`!)
- âš ï¸ `KEYCLOAK_ADMIN_PASSWORD` plain-text v Docker Compose
- âš ï¸ Database credentials plain-text
- âš ï¸ JWT signing keys generovanÃ© on-the-fly

---

## ğŸ—ºï¸ KOMPLETNÃ MAPA KONFIGURACÃ

### Level 1: ZdrojovÃ© Soubory (Templates & Defaults)

```
ğŸ“ Root Directory
â”œâ”€â”€ .env.template                    â† MASTER SOURCE (47 variables)
â”‚   â”œâ”€â”€ Used by: envsubst, Docker Compose, generate-realm.sh
â”‚   â”œâ”€â”€ Contains: DB credentials, Keycloak URLs, SSL paths, secrets
â”‚   â””â”€â”€ Status: âœ… CommitnutÃ½ do Git
â”‚
â”œâ”€â”€ .env                             â† GENERATED (NE v Gitu!)
â”‚   â”œâ”€â”€ Generated by: make env-generate OR ruÄnÄ›
â”‚   â”œâ”€â”€ Same content as .env.template
â”‚   â””â”€â”€ Status: âš ï¸ MÄšLO by bÃ½t v .gitignore, ALE NENÃ!
â”‚
â””â”€â”€ docker-compose.template.yml      â† Docker service definitions
    â”œâ”€â”€ Used by: make compose-generate
    â”œâ”€â”€ Contains: ${VARIABLE} placeholders
    â””â”€â”€ Generated to: docker-compose.yml
```

```
ğŸ“ backend/src/main/resources/
â”œâ”€â”€ application.yml                  â† Backend main config
â”‚   â”œâ”€â”€ Contains: ${ENV_VAR} placeholders
â”‚   â”œâ”€â”€ Values from: Docker environment, JVM -D flags
â”‚   â””â”€â”€ Profiles: default, reporting, test
â”‚
â”œâ”€â”€ application-reporting.yml        â† Reporting profile
â”‚   â”œâ”€â”€ Redis config, Cube.js URLs
â”‚   â””â”€â”€ Merged when profile=reporting active
â”‚
â””â”€â”€ logback-spring.xml              â† Logging config
    â”œâ”€â”€ Loki appender URLs
    â””â”€â”€ Log levels per package
```

```
ğŸ“ docker/keycloak/
â”œâ”€â”€ realm-admin.template.json        â† Keycloak realm SOURCE
â”‚   â”œâ”€â”€ Contains: ${DOMAIN}, ${KEYCLOAK_ADMIN_CLIENT_SECRET}
â”‚   â”œâ”€â”€ Generated by: generate-realm.sh
â”‚   â””â”€â”€ Status: âœ… CommitnutÃ½
â”‚
â”œâ”€â”€ realm-admin.json                â† GENERATED realm
â”‚   â”œâ”€â”€ Generated by: generate-realm.sh (auto pÅ™i 'make kc-image')
â”‚   â”œâ”€â”€ Copied to: Keycloak Docker image /opt/keycloak/data/import/
â”‚   â””â”€â”€ Status: âš ï¸ Gitignored (obsahuje secrets)
â”‚
â””â”€â”€ generate-realm.sh               â† Generator script
    â””â”€â”€ envsubst < template > final
```

```
ğŸ“ docker/nginx/
â”œâ”€â”€ nginx-ssl.conf.template         â† Nginx config SOURCE
â”‚   â”œâ”€â”€ Contains: ${DOMAIN} placeholder
â”‚   â”œâ”€â”€ Generated by: envsubst v Dockerfile
â”‚   â””â”€â”€ Status: âœ… CommitnutÃ½
â”‚
â””â”€â”€ nginx-ssl.conf                  â† GENERATED config
    â”œâ”€â”€ Generated: On container startup
    â””â”€â”€ Status: Runtime only (ne v Gitu)
```

```
ğŸ“ docker/ssl/
â”œâ”€â”€ server.crt.pem                  â† SSL certificate (self-signed)
â”œâ”€â”€ server.key.pem                  â† SSL private key
â”œâ”€â”€ ca.crt.pem                      â† CA certificate
â””â”€â”€ generate-ssl.sh                 â† Generator script
    â””â”€â”€ Creates wildcard cert for *.${DOMAIN}
```

---

## ğŸ” SECRETS & CREDENTIALS INVENTORY

### 1. Database Credentials

#### PostgreSQL Master Credentials
```bash
# Source: .env.template
POSTGRES_USER=core
POSTGRES_PASSWORD=core              # âš ï¸ PLAIN TEXT!
POSTGRES_DB=core

# Used by:
# - docker-compose.yml â†’ postgres service environment
# - Init scripts: docker/postgres/init-*.sql
# - Backend application.yml via DATABASE_URL

# Runtime Access:
docker exec -it core-db psql -U core -d core
# Password: core
```

#### Database URL (JDBC)
```bash
# Source: .env.template
DATABASE_URL=jdbc:postgresql://core-db:5432/core
DATABASE_USERNAME=core
DATABASE_PASSWORD=core              # âš ï¸ PLAIN TEXT!

# Used by:
# - backend/src/main/resources/application.yml
# - Spring Boot DataSource configuration
# - HikariCP connection pool

# Flow:
.env â†’ Docker env â†’ Spring Boot â†’ HikariCP â†’ PostgreSQL
```

#### Secondary Databases
```bash
# Created by: docker/postgres/init-multi-db.sh
# Databases:
# 1. core          - Main application (user: core)
# 2. keycloak      - Keycloak auth (user: core)
# 3. grafana       - Grafana dashboards (user: core)

# Same credentials for all!
# User: core
# Password: core
```

---

### 2. Keycloak Credentials & Secrets

#### Keycloak Admin Credentials
```bash
# Source: .env.template
KEYCLOAK_ADMIN=admin
KEYCLOAK_ADMIN_PASSWORD=admin       # âš ï¸ PLAIN TEXT!

# Used by:
# - docker-compose.yml â†’ keycloak service environment
# - Initial admin user creation
# - Admin console login: https://admin.core-platform.local/admin

# Runtime:
# Username: admin
# Password: admin
# Access: https://admin.core-platform.local/admin/
```

#### Keycloak Database Connection
```bash
# Source: .env.template (implicit)
KC_DB=postgres
KC_DB_URL=jdbc:postgresql://core-db:5432/keycloak
KC_DB_USERNAME=core
KC_DB_PASSWORD=core                 # âš ï¸ PLAIN TEXT!

# Used by:
# - docker-compose.yml â†’ keycloak service environment
# - Keycloak connects to PostgreSQL 'keycloak' database
```

#### OAuth2 Client Secret
```bash
# Source: .env.template
KEYCLOAK_ADMIN_CLIENT_SECRET=<random-uuid>   # âš ï¸ PLAIN TEXT!

# Used by:
# 1. realm-admin.template.json â†’ client.secret
# 2. Backend application.yml â†’ spring.security.oauth2.client.registration.keycloak.client-secret
# 3. JWT token validation

# Flow:
.env.template 
  â†’ generate-realm.sh (envsubst) 
  â†’ realm-admin.json 
  â†’ Keycloak Docker image 
  â†’ Realm import 
  â†’ Client 'admin-client' created with this secret

# Runtime Usage:
# Backend sends: client_id=admin-client, client_secret=<this value>
# Keycloak validates & issues JWT tokens
```

#### OIDC Configuration
```bash
# Source: .env.template
OIDC_CLIENT_ID=admin-client
OIDC_CLIENT_SECRET=${KEYCLOAK_ADMIN_CLIENT_SECRET}  # Same as above
OIDC_ISSUER_URI=https://admin.core-platform.local/realms/admin

# Used by:
# - Backend Spring Security OAuth2 configuration
# - JWT token validation
# - Authorization Code flow

# Flow:
Backend â†’ Keycloak (/realms/admin/protocol/openid-connect/token)
  â†’ JWT token (signed by Keycloak)
  â†’ Backend validates JWT against issuer-uri
```

---

### 3. Redis Credentials

```bash
# Source: .env.template
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=                     # âš ï¸ EMPTY (no auth!)

# Used by:
# - backend/application.yml â†’ spring.data.redis
# - backend/application-reporting.yml â†’ caching

# Security Note:
# Redis bÄ›Å¾Ã­ BEZ hesla v Docker networku!
# PÅ™Ã­stupnÃ½ pouze pÅ™es internal network, NE exposed na host
```

---

### 4. Kafka Credentials

```bash
# Source: .env.template
KAFKA_BOOTSTRAP_SERVERS=kafka:9092

# No authentication configured!
# Plain PLAINTEXT protocol (not SASL)

# Used by:
# - backend/application.yml â†’ spring.kafka
# - CDC events, audit logs
```

---

### 5. MinIO (S3) Credentials

```bash
# Source: .env.template
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin      # âš ï¸ PLAIN TEXT!
MINIO_ENDPOINT=http://minio:9000

# Used by:
# - docker-compose.yml â†’ minio service
# - Backend S3 client (if configured)
# - File uploads, document storage

# Access:
# Console: http://localhost:9001
# API: http://localhost:9000
# Credentials: minioadmin / minioadmin
```

---

### 6. SSL/TLS Certificates

#### Certificate Generation
```bash
# Script: docker/ssl/generate-ssl.sh
# Generates:
# - CA certificate (self-signed root CA)
# - Server certificate (wildcard *.core-platform.local)
# - Private key (4096-bit RSA)

# Command:
openssl req -x509 -nodes -days 365 -newkey rsa:4096 \
  -keyout server.key.pem \
  -out server.crt.pem \
  -subjectAltName "DNS:*.core-platform.local,DNS:core-platform.local"
```

#### Certificate Locations & Usage

```bash
# Source Files:
docker/ssl/
â”œâ”€â”€ server.crt.pem          # Public certificate
â”œâ”€â”€ server.key.pem          # Private key âš ï¸ CRITICAL SECRET!
â””â”€â”€ ca.crt.pem             # CA cert

# Runtime Usage:

1. Nginx (SSL Termination)
   Volume: ./docker/ssl:/etc/nginx/ssl:ro
   Config: 
     ssl_certificate /etc/nginx/ssl/server.crt.pem
     ssl_certificate_key /etc/nginx/ssl/server.key.pem

2. Keycloak (HTTPS Mode)
   Volume: ./docker/ssl:/opt/keycloak/conf:ro
   Env:
     KC_HTTPS_CERTIFICATE_FILE=/opt/keycloak/conf/server.crt.pem
     KC_HTTPS_CERTIFICATE_KEY_FILE=/opt/keycloak/conf/server.key.pem

3. Backend (Java Truststore)
   Import via Dockerfile:
     keytool -importcert -file /ssl/ca.crt.pem \
       -alias core-ca -keystore $JAVA_HOME/lib/security/cacerts \
       -storepass changeit -noprompt
   
   Used for:
   - HTTPS calls to Keycloak
   - SSL validation of JWT issuer
```

---

### 7. Grafana Credentials

```bash
# Source: .env.template
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=admin        # âš ï¸ PLAIN TEXT!

# Database:
GF_DATABASE_TYPE=postgres
GF_DATABASE_HOST=core-db:5432
GF_DATABASE_NAME=grafana
GF_DATABASE_USER=core
GF_DATABASE_PASSWORD=core           # âš ï¸ PLAIN TEXT!

# Used by:
# - docker-compose.yml â†’ grafana service
# - Grafana web UI login

# Access:
# URL: https://admin.core-platform.local/grafana/
# Username: admin
# Password: admin
```

---

### 8. Cube.js (Analytics)

```bash
# Source: .env.template
CUBE_BASE_URL=http://cube:4000
CUBE_API_TOKEN=                     # âš ï¸ EMPTY or random

# Used by:
# - backend/application-reporting.yml
# - Reporting API calls to Cube.js

# Note: Token mÅ¯Å¾e bÃ½t empty pro dev environment
```

---

## ğŸ”„ CONFIGURATION FLOW DIAGRAMS

### Flow 1: Build-Time Configuration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BUILD TIME (make up / make rebuild)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. .env.template (source of truth)
   â”‚
   â”œâ”€â†’ make env-generate (optional)
   â”‚   â””â”€â†’ .env (copy of template)
   â”‚
   â”œâ”€â†’ docker-compose.template.yml
   â”‚   â””â”€â†’ make compose-generate
   â”‚       â””â”€â†’ docker-compose.yml (envsubst substitution)
   â”‚
   â”œâ”€â†’ make kc-image
   â”‚   â””â”€â†’ generate-realm.sh
   â”‚       â”œâ”€ envsubst < realm-admin.template.json
   â”‚       â””â”€â†’ realm-admin.json (with real secrets)
   â”‚           â””â”€â†’ Copied to Keycloak Docker image
   â”‚
   â””â”€â†’ Nginx Dockerfile
       â”œâ”€ envsubst < nginx-ssl.conf.template
       â””â”€â†’ nginx-ssl.conf (with ${DOMAIN} replaced)
```

### Flow 2: Runtime Configuration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RUNTIME (docker compose up)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Docker Compose Startup
   â”‚
   â”œâ”€â†’ Reads .env file
   â”‚   â””â”€â†’ Exports as environment variables to containers
   â”‚
   â”œâ”€â†’ PostgreSQL Container
   â”‚   â”œâ”€ POSTGRES_USER=core
   â”‚   â”œâ”€ POSTGRES_PASSWORD=core
   â”‚   â””â”€ Creates databases: core, keycloak, grafana
   â”‚
   â”œâ”€â†’ Keycloak Container
   â”‚   â”œâ”€ KEYCLOAK_ADMIN=admin
   â”‚   â”œâ”€ KEYCLOAK_ADMIN_PASSWORD=admin
   â”‚   â”œâ”€ KC_DB_URL=jdbc:postgresql://core-db:5432/keycloak
   â”‚   â”œâ”€ Imports /opt/keycloak/data/import/realm-admin.json
   â”‚   â””â”€ Creates realm 'admin' with client secrets
   â”‚
   â”œâ”€â†’ Backend Container
   â”‚   â”œâ”€ DATABASE_URL=jdbc:postgresql://core-db:5432/core
   â”‚   â”œâ”€ OIDC_ISSUER_URI=https://admin.core-platform.local/realms/admin
   â”‚   â”œâ”€ Spring Boot reads environment variables
   â”‚   â”œâ”€ application.yml: ${DATABASE_URL}, ${OIDC_ISSUER_URI}
   â”‚   â””â”€ Connects to PostgreSQL, Keycloak, Redis
   â”‚
   â”œâ”€â†’ Nginx Container
   â”‚   â”œâ”€ Mounts ./docker/ssl:/etc/nginx/ssl
   â”‚   â”œâ”€ Uses nginx-ssl.conf (generated at build)
   â”‚   â””â”€ SSL termination on port 443
   â”‚
   â””â”€â†’ Frontend Container
       â”œâ”€ Nginx serves static files
       â””â”€ VITE_API_URL set at build time
```

### Flow 3: Secret Substitution Tracking

```
SECRET: KEYCLOAK_ADMIN_CLIENT_SECRET
â”‚
â”œâ”€ SOURCE: .env.template (line X)
â”‚   Value: "abc123-secret-uuid"
â”‚
â”œâ”€ USAGE 1: Keycloak Realm Import
â”‚   â”‚
â”‚   â”œâ”€â†’ generate-realm.sh
â”‚   â”‚   â””â”€ envsubst replaces ${KEYCLOAK_ADMIN_CLIENT_SECRET}
â”‚   â”‚
â”‚   â”œâ”€â†’ realm-admin.json
â”‚   â”‚   "clients": [{
â”‚   â”‚     "clientId": "admin-client",
â”‚   â”‚     "secret": "abc123-secret-uuid"  â† SUBSTITUTED
â”‚   â”‚   }]
â”‚   â”‚
â”‚   â””â”€â†’ Keycloak imports â†’ Client created with this secret
â”‚
â””â”€ USAGE 2: Backend OAuth2 Client
    â”‚
    â”œâ”€â†’ .env â†’ Docker environment
    â”‚
    â”œâ”€â†’ Backend container env: OIDC_CLIENT_SECRET=abc123-secret-uuid
    â”‚
    â””â”€â†’ application.yml
        spring:
          security:
            oauth2:
              client:
                registration:
                  keycloak:
                    client-secret: ${OIDC_CLIENT_SECRET}  â† SUBSTITUTED
```

---

## ğŸ“Š ENVIRONMENT VARIABLES MASTER TABLE

| Variable | Source | Substituted Where | Used By | Runtime Value | Security Level |
|----------|--------|-------------------|---------|---------------|----------------|
| **Database** |
| `POSTGRES_USER` | .env.template | docker-compose.yml | PostgreSQL | `core` | ğŸ”´ SECRET |
| `POSTGRES_PASSWORD` | .env.template | docker-compose.yml | PostgreSQL | `core` | ğŸ”´ SECRET |
| `POSTGRES_DB` | .env.template | docker-compose.yml | PostgreSQL | `core` | ğŸŸ¢ Public |
| `DATABASE_URL` | .env.template | docker-compose.yml | Backend | `jdbc:postgresql://core-db:5432/core` | ğŸŸ¡ Internal |
| `DATABASE_USERNAME` | .env.template | docker-compose.yml | Backend | `core` | ğŸ”´ SECRET |
| `DATABASE_PASSWORD` | .env.template | docker-compose.yml | Backend | `core` | ğŸ”´ SECRET |
| **Keycloak Auth** |
| `KEYCLOAK_ADMIN` | .env.template | docker-compose.yml | Keycloak | `admin` | ğŸ”´ SECRET |
| `KEYCLOAK_ADMIN_PASSWORD` | .env.template | docker-compose.yml | Keycloak | `admin` | ğŸ”´ SECRET |
| `KEYCLOAK_BASE_URL` | .env.template | docker-compose.yml, realm.json | Backend, Keycloak | `https://admin.core-platform.local` | ğŸŸ¢ Public |
| `KEYCLOAK_ADMIN_CLIENT_SECRET` | .env.template | realm.json, docker-compose.yml | Keycloak, Backend | `<uuid>` | ğŸ”´ SECRET |
| `OIDC_CLIENT_ID` | .env.template | docker-compose.yml | Backend | `admin-client` | ğŸŸ¢ Public |
| `OIDC_CLIENT_SECRET` | .env.template | docker-compose.yml | Backend | `${KEYCLOAK_ADMIN_CLIENT_SECRET}` | ğŸ”´ SECRET |
| `OIDC_ISSUER_URI` | .env.template | docker-compose.yml | Backend | `https://admin.core-platform.local/realms/admin` | ğŸŸ¢ Public |
| **Domain & SSL** |
| `DOMAIN` | .env.template | nginx.conf, realm.json | Nginx, Keycloak | `core-platform.local` | ğŸŸ¢ Public |
| `SSL_CERT_PATH` | .env.template | docker-compose.yml | Nginx, Keycloak | `./docker/ssl/server.crt.pem` | ğŸŸ¢ Public |
| `SSL_KEY_PATH` | .env.template | docker-compose.yml | Nginx, Keycloak | `./docker/ssl/server.key.pem` | ğŸ”´ SECRET |
| **Redis** |
| `REDIS_HOST` | .env.template | docker-compose.yml | Backend | `redis` | ğŸŸ¢ Public |
| `REDIS_PORT` | .env.template | docker-compose.yml | Backend | `6379` | ğŸŸ¢ Public |
| `REDIS_PASSWORD` | .env.template | docker-compose.yml | Backend, Redis | `` (empty) | ğŸŸ¡ None |
| **Kafka** |
| `KAFKA_BOOTSTRAP_SERVERS` | .env.template | docker-compose.yml | Backend | `kafka:9092` | ğŸŸ¢ Public |
| **MinIO (S3)** |
| `MINIO_ROOT_USER` | .env.template | docker-compose.yml | MinIO | `minioadmin` | ğŸ”´ SECRET |
| `MINIO_ROOT_PASSWORD` | .env.template | docker-compose.yml | MinIO | `minioadmin` | ğŸ”´ SECRET |
| `MINIO_ENDPOINT` | .env.template | docker-compose.yml | Backend | `http://minio:9000` | ğŸŸ¢ Public |
| **Grafana** |
| `GRAFANA_ADMIN_USER` | .env.template | docker-compose.yml | Grafana | `admin` | ğŸ”´ SECRET |
| `GRAFANA_ADMIN_PASSWORD` | .env.template | docker-compose.yml | Grafana | `admin` | ğŸ”´ SECRET |
| `GF_DATABASE_HOST` | .env.template | docker-compose.yml | Grafana | `core-db:5432` | ğŸŸ¢ Public |
| `GF_DATABASE_NAME` | .env.template | docker-compose.yml | Grafana | `grafana` | ğŸŸ¢ Public |
| `GF_DATABASE_USER` | .env.template | docker-compose.yml | Grafana | `core` | ğŸ”´ SECRET |
| `GF_DATABASE_PASSWORD` | .env.template | docker-compose.yml | Grafana | `core` | ğŸ”´ SECRET |
| **Cube.js** |
| `CUBE_BASE_URL` | .env.template | docker-compose.yml | Backend | `http://cube:4000` | ğŸŸ¢ Public |
| `CUBE_API_TOKEN` | .env.template | docker-compose.yml | Backend | `` (empty) | ğŸŸ¡ None |
| **Ports** |
| `BACKEND_PORT` | .env.template | docker-compose.yml | Backend | `8080` | ğŸŸ¢ Public |
| `FRONTEND_PORT` | .env.template | docker-compose.yml | Frontend | `3000` | ğŸŸ¢ Public |
| `KEYCLOAK_PORT` | .env.template | docker-compose.yml | Keycloak | `8080` (internal) | ğŸŸ¢ Public |
| `KEYCLOAK_HTTPS_PORT` | .env.template | docker-compose.yml | Keycloak | `8443` | ğŸŸ¢ Public |

---

## ğŸ” KRITICKÃ‰ NÃLEZY & DOPORUÄŒENÃ

### ğŸ”´ CRITICAL Security Issues

1. **Plain-text Secrets v .env**
   ```bash
   # ProblÃ©m:
   POSTGRES_PASSWORD=core              # NenÃ­ encrypted!
   KEYCLOAK_ADMIN_PASSWORD=admin       # Plain text!
   KEYCLOAK_ADMIN_CLIENT_SECRET=abc... # KompletnÄ› visible!
   
   # Riziko:
   - Pokud .env leak do Gitu â†’ vÅ¡echny secrets compromised
   - NenÃ­ rotace secrets
   - Shared credentials napÅ™Ã­Ä sluÅ¾bami
   
   # DoporuÄenÃ­:
   - PouÅ¾Ã­t Docker Secrets nebo Vault
   - Rotace credentials kaÅ¾dÃ½ mÄ›sÃ­c
   - OddÄ›lit dev/staging/prod credentials
   ```

2. **StejnÃ© Heslo Pro VÅ¡echny DatabÃ¡ze**
   ```bash
   # PostgreSQL user 'core' mÃ¡ pÅ™Ã­stup k:
   - core database (main app)
   - keycloak database (auth)
   - grafana database (monitoring)
   
   # Riziko:
   - SQL injection v aplikaci â†’ pÅ™Ã­stup ke Keycloak DB
   - Kompromitace jednÃ© DB â†’ kompromitace vÅ¡ech
   
   # DoporuÄenÃ­:
   - SamostatnÃ½ user pro kaÅ¾dou databÃ¡zi
   - Row-level security policies
   ```

3. **SSL Private Key v Plain Text**
   ```bash
   # docker/ssl/server.key.pem commitnutÃ½ do Gitu!
   
   # Riziko:
   - Kdokoli s pÅ™Ã­stupem k repo mÃ¡ SSL private key
   - MITM attack moÅ¾nÃ½
   
   # DoporuÄenÃ­:
   - .gitignore pro *.key.pem
   - Generovat na deployment, ne commit
   ```

### ğŸŸ¡ MEDIUM Issues

4. **Redis Bez Autentizace**
   ```bash
   REDIS_PASSWORD=  # Empty!
   
   # Riziko:
   - Kdokoli v Docker networku mÅ¯Å¾e ÄÃ­st/zapisovat cache
   - Session hijacking moÅ¾nÃ½
   
   # DoporuÄenÃ­:
   - Nastavit requirepass v Redis
   - ACL policies pro rÅ¯znÃ© aplikace
   ```

5. **Kafka Bez Encryption**
   ```bash
   # PLAINTEXT protocol, not SASL_SSL
   
   # Riziko:
   - CDC events, audit logs ÄitelnÃ© plain text
   - MITM attack moÅ¾nÃ½
   
   # DoporuÄenÃ­:
   - SASL_SSL s authentication
   - Encryption at rest
   ```

6. **Template Substitution Chaos**
   ```bash
   # 3 rÅ¯znÃ© mechanismy substituce:
   1. envsubst (Bash)
   2. Docker Compose ${VAR}
   3. Spring Boot ${ENV_VAR}
   
   # ProblÃ©m:
   - NepÅ™ehlednÃ© kde se co substituuje
   - Debugging obtÃ­Å¾nÃ½
   - RÅ¯znÃ© escape rules
   
   # DoporuÄenÃ­:
   - Standardizovat na jeden mechanismus
   - Dokumentovat kaÅ¾dou substituci
   ```

### ğŸŸ¢ GOOD Practices

7. **SSL Wildcard CertifikÃ¡t** âœ…
   ```bash
   # *.core-platform.local pokrÃ½vÃ¡ vÅ¡echny subdomÃ©ny
   # SprÃ¡vnÃ© SAN (Subject Alternative Names)
   ```

8. **Separate Profiles** âœ…
   ```bash
   # application.yml, application-reporting.yml
   # OddÄ›lit concerns
   ```

9. **Build Doctor Diagnostics** âœ…
   ```bash
   # AutomatickÃ© health checks
   # JSON reporting
   ```

---

## ï¿½ CODE AUDIT: Hardcoded Values vs Environment Variables

**ÃšÄel:** NajÃ­t vÅ¡echny hardcoded hodnoty v kÃ³du, ovÄ›Å™it sprÃ¡vnÃ© pouÅ¾Ã­vÃ¡nÃ­ env vars, identifikovat nesrovnalosti

### 1. Database URLs - KRITICKÃ PROBLÃ‰M NALEZEN âŒ

#### Hardcoded DB URLs v `application.properties`

**Soubor:** `backend/src/main/resources/application.properties`

```properties
# âŒ HARDCODED - BYPASS ENV VARS!
spring.datasource.url=jdbc:postgresql://db:5432/core
keycloak.datasource.url=jdbc:postgresql://db:5432/keycloak
```

**ProblÃ©m:**
- Tyto hodnoty PÅ˜EPÃÅ Ã environment variables z Docker Compose
- Nelze zmÄ›nit DB host/port/name bez rebuildu
- Ignoruje `DATABASE_URL` z `.env`

**SprÃ¡vnÃ¡ implementace (v `application.yml`):**
```yaml
spring:
  datasource:
    url: ${DATABASE_URL:jdbc:postgresql://core-db:5432/core}  # âœ… PouÅ¾itÃ­ env var
```

**Dopad:**
- âš ï¸ Produkce nemÅ¯Å¾e override DB URL
- âš ï¸ Dev Container nemÅ¯Å¾e pouÅ¾Ã­t jinÃ½ DB host
- âš ï¸ Testing musÃ­ hardcoded hodnoty respektovat

---

### 2. Subdomain Hardcoding - ÄŒÃ¡steÄnÄ› OK âš ï¸

#### SprÃ¡vnÃ© pouÅ¾itÃ­ `${DOMAIN}` variable

**Soubor:** `.env.template`
```bash
DOMAIN=core-platform.local
KEYCLOAK_BASE_URL=https://admin.${DOMAIN}
OIDC_ISSUER_URI=https://admin.${DOMAIN}/realms/admin
```

**PouÅ¾itÃ­ v kÃ³du:**
```properties
# backend/src/main/resources/application.properties
cors.origins=${CORS_ORIGINS:https://*.${DOMAIN:core-platform.local},https://${DOMAIN:core-platform.local},http://localhost}
```

âœ… **SPRÃVNÄš**: PouÅ¾Ã­vÃ¡ `${DOMAIN}` s fallback hodnotou

#### Hardcoded subdomÃ©ny v dokumentaci a testech

**Soubory s hardcoded `core-platform.local`:**
- Makefile (50+ vÃ½skytÅ¯) - pouze v echo messages âœ… OK
- README.md - dokumentace a pÅ™Ã­klady âœ… OK
- E2E testy (`e2e/.env.example`) - defaulty âœ… OK
  ```bash
  PRE_BASE_URL=https://core-platform.local
  POST_BASE_URL=https://core-platform.local
  ```

**ProblematickÃ© hardcoded hodnoty:**
```typescript
// e2e/helpers/fixtures.ts
const API_BASE = process.env.API_BASE || 'https://admin.core-platform.local';  // âš ï¸ Fallback OK, ale mÄ›l by ÄÃ­st DOMAIN
```

```typescript
// e2e/config/read-config.ts
const domain = expanded['DOMAIN'] || 'core-platform.local';  // âœ… OK - mÃ¡ fallback
```

**ZÃ¡vÄ›r:** VÄ›tÅ¡ina hardcoded subdomain je v poÅ™Ã¡dku (dokumentace, fallbacky). Å½Ã¡dnÃ¡ kritickÃ¡ aplikaÄnÃ­ logika to nepouÅ¾Ã­vÃ¡.

---

### 3. Port Hardcoding - SmÃ­Å¡enÃ¡ Kvalita âš ï¸

#### Backend Internal Ports - OK âœ…

**Docker Compose sprÃ¡vnÄ› izoluje porty:**
```yaml
# docker/docker-compose.yml
backend:
  expose:
    - "8080"  # âœ… POUZE internal - nenÃ­ publikovanÃ½ ven
  
keycloak:
  expose:
    - "8443"  # âœ… POUZE internal
```

**Nginx routing (sprÃ¡vnÃ©):**
```nginx
upstream backend {
    server backend:8080;  # âœ… Container internal port
}

upstream keycloak {
    server keycloak:8443;  # âœ… Container internal port (HTTPS!)
}

upstream grafana {
    server grafana:3000;  # âœ… Container internal port
}
```

#### Test Port Hardcoding - PÅ™ijatelnÃ© âœ…

**Test files (localhost acceptable):**
```properties
# backend/src/test/resources/application-test.properties
spring.datasource.url=jdbc:postgresql://localhost:5432/testdb  # âœ… OK pro testy
```

```yaml
# backend/src/test/resources/application-test.yml
keycloak:
  admin:
    base-url: http://localhost:8080  # âœ… OK pro testy
```

**GitHub Actions (acceptable):**
```yaml
# .github/workflows/ci.yml
KEYCLOAK_ADMIN_BASE_URL=http://keycloak:8080  # âœ… OK pro CI
```

#### Dev Scripts - SprÃ¡vnÃ© pouÅ¾itÃ­ env vars âœ…

```bash
# scripts/infra-smoke-test.sh
BACKEND_URL="${BACKEND_URL:-http://localhost:8080}"  # âœ… Env var s fallbackem
GRAFANA_URL="${GRAFANA_URL:-http://localhost:3000}"  # âœ… Env var s fallbackem
```

**ZÃ¡vÄ›r:** Port hardcoding je v poÅ™Ã¡dku - pouÅ¾Ã­vÃ¡ se pouze pro internal container routing nebo test fallbacks.

---

### 4. Credentials Hardcoding - VÃÅ½NÃ PROBLÃ‰M âš ï¸

#### Plain-text Passwords v `.env`

**Soubor:** `.env` (generated from `.env.template`)

```bash
# âŒ Plain-text secrets
POSTGRES_PASSWORD=core
DATABASE_PASSWORD=core
KEYCLOAK_DB_PASSWORD=core
GRAFANA_DB_PASSWORD=core

KEYCLOAK_ADMIN_PASSWORD=admin
KEYCLOAK_ADMIN_CLIENT_SECRET=7c4a7e8f-6b3d-4f2e-9a1c-5d8e7f6a9b2c

MINIO_ROOT_PASSWORD=minioadmin
GRAFANA_ADMIN_PASSWORD=admin
```

**ProblÃ©m:**
- âš ï¸ VÅ¡echny DB hesla stejnÃ¡ ("core")
- âš ï¸ `.env` soubor NENÃ v `.gitignore` (mÅ¯Å¾e bÃ½t commitnut!)
- âš ï¸ Å½Ã¡dnÃ¡ rotace credentials
- âš ï¸ Redis BEZ autentizace (`REDIS_PASSWORD` prÃ¡zdnÃ©)

#### SprÃ¡vnÃ© pouÅ¾itÃ­ credentials v kÃ³du âœ…

**Backend kÃ³d NEPOPISUJE hesla:**
```java
// backend/src/main/java/cz/muriel/core/auth/config/SecurityConfig.java
@Value("${cors.origins:http://localhost:3000}")  // âœ… PouÅ¾Ã­vÃ¡ env var
private String[] corsOrigins;
```

```yaml
# backend/src/main/resources/application.yml
spring:
  datasource:
    username: ${DATABASE_USERNAME:postgres}  # âœ… PouÅ¾Ã­vÃ¡ env var
    password: ${DATABASE_PASSWORD}           # âœ… PouÅ¾Ã­vÃ¡ env var (bez defaultu!)
```

**ZÃ¡vÄ›r:** KÃ³d sprÃ¡vnÄ› pouÅ¾Ã­vÃ¡ env vars pro credentials, ale `.env` obsahuje slabÃ©/duplicitnÃ­ hesla.

---

### 5. CORS Origins - SprÃ¡vnÃ© PouÅ¾itÃ­ âœ…

**Soubor:** `backend/src/main/resources/application.properties`

```properties
# âœ… SprÃ¡vnÄ› pouÅ¾Ã­vÃ¡ env var s intelligent fallbackem
cors.origins=${CORS_ORIGINS:https://*.${DOMAIN:core-platform.local},https://${DOMAIN:core-platform.local},http://localhost}
```

**Template definice:**
```bash
# .env.template
CORS_ORIGINS=http://localhost:3000,https://*.${DOMAIN},https://${DOMAIN}
```

**PouÅ¾itÃ­ v kÃ³du:**
```java
// backend/src/main/java/cz/muriel/core/auth/config/SecurityConfig.java
@Value("${cors.origins:http://localhost:3000}")
private String[] corsOrigins;
```

âœ… **VÃBORNÄš**: MÃ¡ fallback, pouÅ¾Ã­vÃ¡ env var, podporuje wildcards, zahrnuje localhost pro dev

---

### 6. API Endpoints - SprÃ¡vnÃ© PouÅ¾itÃ­ Env Vars âœ…

#### Backend k Keycloak komunikace

**Docker Compose (sprÃ¡vnÄ›):**
```yaml
environment:
  KEYCLOAK_BASE_URL: ${KEYCLOAK_BASE_URL:-https://admin.core-platform.local}
  OIDC_ISSUER_URI: ${OIDC_ISSUER_URI:-https://admin.core-platform.local/realms/admin}
```

**Application config (sprÃ¡vnÄ›):**
```yaml
# backend/src/main/resources/application.yml
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${OIDC_ISSUER_URI}  # âœ… ÄŒte z env
```

#### Cube.js API URL

**KÃ³d s fallbackem:**
```java
// backend/src/main/java/cz/muriel/core/reporting/config/CubeWebClientConfiguration.java
@Value("${cube.api.url:http://localhost:4000}")  // âœ… Fallback pro dev
private String cubeApiUrl;
```

**Template:**
```bash
CUBE_API_URL=http://cubejs:4000  # âœ… Container internal URL
```

âœ… **SPRÃVNÄš**: API URLs pouÅ¾Ã­vajÃ­ env vars, majÃ­ fallbacky pro dev

---

## âš ï¸ NESROVNALOSTI A OPRAVY

### ğŸ”´ KRITICKÃ PROBLÃ‰M #1: Hardcoded DB URLs v `application.properties`

**Soubor:** `backend/src/main/resources/application.properties:17,27`

**SouÄasnÃ½ stav:**
```properties
spring.datasource.url=jdbc:postgresql://db:5432/core
keycloak.datasource.url=jdbc:postgresql://db:5432/keycloak
```

**OÄekÃ¡vanÃ½ stav:**
```properties
# application.properties by NEMÄšL obsahovat DB URLs - pouÅ¾Ã­t application.yml
```

**application.yml by mÄ›l mÃ­t:**
```yaml
spring:
  datasource:
    url: ${DATABASE_URL:jdbc:postgresql://core-db:5432/core}

keycloak:
  datasource:
    url: ${KEYCLOAK_DATABASE_URL:jdbc:postgresql://core-db:5432/keycloak}
```

**Dopad:**
- âŒ Environment variables se IGNORUJÃ
- âŒ Nelze override DB URL v produkci
- âŒ Dev Container nemÅ¯Å¾e pouÅ¾Ã­t jinÃ½ DB host
- âŒ Properties file mÃ¡ VYÅ Å Ã prioritu neÅ¾ env vars!

**NÃ¡vrh opravy:**

```bash
# 1. SMAZAT Å™Ã¡dky z application.properties
vim backend/src/main/resources/application.properties
# Odstranit Å™Ã¡dky 17 a 27:
# spring.datasource.url=jdbc:postgresql://db:5432/core
# keycloak.datasource.url=jdbc:postgresql://db:5432/keycloak

# 2. PÅ˜IDAT do application.yml (pokud uÅ¾ tam nenÃ­)
vim backend/src/main/resources/application.yml
# PÅ™idat:
# spring:
#   datasource:
#     url: ${DATABASE_URL:jdbc:postgresql://core-db:5432/core}
#
# keycloak:
#   datasource:
#     url: ${KEYCLOAK_DATABASE_URL:jdbc:postgresql://core-db:5432/keycloak}

# 3. OVÄšÅ˜IT Å¾e env vars jsou v docker-compose.yml
grep -A5 "backend:" docker/docker-compose.yml | grep DATABASE_URL

# 4. REBUILD a test
make clean-fast
make logs-backend | grep -i "datasource"
```

**Priorita:** ğŸ”´ **CRITICAL** - Opravit IHNED

---

### ğŸŸ¡ MEDIUM PROBLÃ‰M #2: NekonzistentnÃ­ DB nÃ¡zev v `.env.example`

**Soubor:** `.env.example:44`, `.env.backup:44`

**SouÄasnÃ½ stav:**
```bash
DATABASE_URL=jdbc:postgresql://core-db:5432/core_platform  # âŒ Å PATNÃ nÃ¡zev DB!
```

**SprÃ¡vnÃ½ stav (v `.env`):**
```bash
DATABASE_URL=jdbc:postgresql://core-db:5432/core  # âœ… SPRÃVNÄš
```

**Dopad:**
- âš ï¸ NovÃ½ developer zkopÃ­ruje `.env.example` â†’ aplikace nenastartuje
- âš ï¸ PostgreSQL error: `database "core_platform" does not exist`
- âš ï¸ MatoucÃ­ onboarding experience

**NÃ¡vrh opravy:**

```bash
# 1. Opravit .env.example
sed -i '' 's|core_platform|core|g' .env.example

# 2. Opravit .env.backup (pokud se pouÅ¾Ã­vÃ¡)
sed -i '' 's|core_platform|core|g' .env.backup

# 3. Commit zmÄ›ny
git add .env.example .env.backup
git commit -m "fix: Correct database name in .env.example (core not core_platform)"
```

**Priorita:** ğŸŸ¡ **MEDIUM** - Opravit tento tÃ½den (matoucÃ­ pro novÃ© devy)

---

### ğŸŸ¡ MEDIUM PROBLÃ‰M #3: `.env` nenÃ­ v `.gitignore`

**SouÄasnÃ½ stav:**
```bash
$ cat .gitignore | grep "^\.env$"
# ... nic ...
```

`.env` obsahuje secrets a MÅ®Å½E bÃ½t commitnut do Gitu!

**OÄekÃ¡vanÃ½ stav:**
```bash
# .gitignore by mÄ›l obsahovat:
.env
.env.local
.env.*.local
docker/ssl/*.key.pem
docker/ssl/*.key
```

**Dopad:**
- ğŸ”´ Plain-text secrets mohou uniknout do Git history
- ğŸ”´ Credentials sdÃ­lenÃ© pÅ™es GitHub
- ğŸ”´ Security audit compliance failure

**NÃ¡vrh opravy:**

```bash
# 1. PÅ™idat do .gitignore
cat >> .gitignore << 'EOF'

# Environment files with secrets
.env
.env.local
.env.*.local

# SSL private keys
docker/ssl/*.key.pem
docker/ssl/*.key
EOF

# 2. OvÄ›Å™it Å¾e .env NENÃ v Gitu
git rm --cached .env 2>/dev/null || echo ".env was not tracked"

# 3. Commit
git add .gitignore
git commit -m "security: Add .env and SSL keys to .gitignore"

# 4. Audit Git history (pokud .env byl commitnut)
git log --all --full-history -- .env
# Pokud existuje historie, zvaÅ¾it BFG Repo-Cleaner nebo git filter-branch
```

**Priorita:** ğŸŸ¡ **MEDIUM** - Opravit tento tÃ½den (security risk)

---

### ï¿½ MEDIUM PROBLÃ‰M #4: ChybÄ›jÃ­cÃ­ Grafana DB credentials v `.env.template`

**Soubor:** `.env.template` (chybÃ­ promÄ›nnÃ©)

**SouÄasnÃ½ stav:**
```bash
# .env.template obsahuje POUZE:
GRAFANA_ADMIN_PASSWORD=admin123
GRAFANA_OIDC_SECRET=grafana-ops-secret-change-me-in-prod

# âŒ CHYBÃ databÃ¡zovÃ© credentials!
```

**docker-compose.yml POUÅ½ÃVÃ:**
```yaml
environment:
  - GF_DATABASE_NAME=${GRAFANA_DB_NAME}           # âŒ Undefined!
  - GF_DATABASE_USER=${GRAFANA_DB_USERNAME}       # âŒ Undefined!
  - GF_DATABASE_PASSWORD=${GRAFANA_DB_PASSWORD}   # âŒ Undefined!
```

**Dopad:**
- âš ï¸ Grafana nemÅ¯Å¾e nastartovat (missing DB credentials)
- âš ï¸ NovÃ½ developer kopÃ­ruje .env.template â†’ Grafana fails
- âš ï¸ Nekonzistence s ostatnÃ­mi sluÅ¾bami (Backend, Keycloak majÃ­ DB credentials)

**OÄekÃ¡vanÃ½ stav:**
```bash
# .env.template by mÄ›l obsahovat:
GRAFANA_DB_NAME=grafana
GRAFANA_DB_USERNAME=core
GRAFANA_DB_PASSWORD=core

# Po migraci na separate users (viz DB_SEPARATE_USERS_PLAN.md):
GRAFANA_DB_USERNAME=grafana_app
GRAFANA_DB_PASSWORD=<strong-password>
```

**NÃ¡vrh opravy:**

```bash
# 1. PÅ™idat do .env.template (âœ… HOTOVO)
cat >> .env.template << 'EOF'

# ğŸ—„ï¸ GRAFANA DATABASE CONFIGURATION
GRAFANA_DB_NAME=grafana
GRAFANA_DB_USERNAME=core
GRAFANA_DB_PASSWORD=core
EOF

# 2. PÅ™idat fallbacky do docker-compose.yml (âœ… HOTOVO)
# - GF_DATABASE_NAME=${GRAFANA_DB_NAME:-grafana}
# - GF_DATABASE_USER=${GRAFANA_DB_USERNAME:-core}
# - GF_DATABASE_PASSWORD=${GRAFANA_DB_PASSWORD:-core}

# 3. Verify
grep GRAFANA_DB .env.template
docker compose config | grep GF_DATABASE
```

**Priorita:** ğŸŸ¡ **MEDIUM** - âœ… **OPRAVENO** (credentials pÅ™idÃ¡ny do .env.template a docker-compose.yml)

---

### ï¿½ğŸŸ¢ GOOD PRÃCE #1: Redis timeout fix

**Soubor:** `backend/src/main/resources/application-reporting.yml:35`

**ProblÃ©m (opraveno):**
```yaml
# PÅ˜ED:
timeout: 2000ms  # âŒ String - NumberFormatException

# PO:
timeout: 2000    # âœ… Integer - funguje
```

âœ… **FIX ZACHOVÃN** pÅ™i revertu dev mode experimentÅ¯

---

## ğŸ“– PROÄŒ EXISTUJÃ TEMPLATY?

### Template System Explained

**ProblÃ©m:** Keycloak realm config (`realm-admin.json`) je STATICKÃ soubor importovanÃ½ pÅ™i startu.  
**Nelze pouÅ¾Ã­t:** Environment variables pÅ™Ã­mo v JSON (Keycloak je neÄte)

**Å˜eÅ¡enÃ­:** Build-time substitution pomocÃ­ `envsubst`

#### Flow: Template â†’ Generated Config

```mermaid
graph LR
    A[.env.template] --> B[.env]
    B --> C[envsubst]
    D[realm-admin.template.json] --> C
    C --> E[realm-admin.json]
    E --> F[Keycloak Import]
    F --> G[Runtime Config]
```

#### PÅ™Ã­klad: Keycloak Realm Template

**Source:** `docker/keycloak/realm-admin.template.json`
```json
{
  "clients": [{
    "clientId": "backend-service",
    "secret": "${KEYCLOAK_ADMIN_CLIENT_SECRET}",
    "redirectUris": ["https://${DOMAIN}/*"]
  }]
}
```

**Build command:** `bash docker/keycloak/generate-realm.sh`
```bash
#!/bin/bash
# ÄŒte .env a aplikuje envsubst
source .env
envsubst < realm-admin.template.json > realm-admin.json
```

**Generated:** `docker/keycloak/realm-admin.json`
```json
{
  "clients": [{
    "clientId": "backend-service",
    "secret": "7c4a7e8f-6b3d-4f2e-9a1c-5d8e7f6a9b2c",
    "redirectUris": ["https://core-platform.local/*"]
  }]
}
```

**Runtime:** Keycloak importuje vygenerovanÃ½ `realm-admin.json` pÅ™i startu
```bash
docker run -v ./realm-admin.json:/opt/keycloak/data/import/realm-admin.json \
  quay.io/keycloak/keycloak:26.0 \
  start --import-realm
```

#### ProÄ 3 Substitution Mechanisms?

| Mechanism | Use Case | Why Needed |
|-----------|----------|------------|
| **envsubst** (Bash) | Keycloak realm.json, Nginx config | Files imported at container startup - can't use runtime env vars |
| **Docker Compose `${VAR}`** | Container environment injection | Docker's native variable substitution for `environment:` sections |
| **Spring Boot `${ENV_VAR}`** | Application properties | Runtime Java property resolution from OS env vars |

**Nelze pouÅ¾Ã­t JEDEN mechanismus:**
- Keycloak realm MUSÃ bÃ½t vygenerovÃ¡n pÅ™ed importem (no runtime substitution)
- Nginx config MUSÃ mÃ­t `${DOMAIN}` resolved pÅ™ed startem (upstream server names)
- Spring Boot properties MOHOU pouÅ¾Ã­t runtime env vars (flexibility)

**Alternativa by vyÅ¾adovala:**
- Keycloak API calls po startu (sloÅ¾itÃ©, race conditions)
- Hardcoded domain names (Å¾Ã¡dnÃ¡ konfigurovatelnost)
- Custom init containers v Kubernetes (overhead)

**ZÃ¡vÄ›r:** Template system je NUTNÃ pro build-time config generation. NenÃ­ to "tech debt", je to architectural constraint Keycloak/Nginx stacku.

---

## ğŸ“ DOPORUÄŒENÃ‰ AKCE

### Priorita 1 (IHNED) - KRITICKÃ‰ OPRAVY
1. ğŸ”´ **Opravit hardcoded DB URLs v `application.properties`**
   - Smazat `spring.datasource.url` a `keycloak.datasource.url` z properties
   - PÅ™esunout do `application.yml` s `${DATABASE_URL}` placeholders
   - Rebuild a ovÄ›Å™it Å¾e env vars fungujÃ­
   - **DÅ¯vod:** Properties file pÅ™episuje env vars â†’ produkce nefunguje

2. ğŸ”´ **PÅ™idat `.env` do `.gitignore`**
   - PÅ™idat `.env`, `.env.local`, `docker/ssl/*.key.pem`
   - Odstranit `.env` z Git tracking (`git rm --cached .env`)
   - Audit Git history jestli .env nebyl commitnut
   - **DÅ¯vod:** Secrets mohou uniknout do Gitu

3. ğŸŸ¡ **Opravit `.env.example` database name**
   - ZmÄ›nit `core_platform` â†’ `core`
   - Commit a push
   - **DÅ¯vod:** NovÃ½ developer kopÃ­ruje example â†’ app crashes

### Priorita 2 (Tento tÃ½den) - BEZPEÄŒNOST
4. âš ï¸ **OddÄ›lit DB credentials (1 user per database)**
   ```sql
   -- VytvoÅ™it separÃ¡tnÃ­ users pro kaÅ¾dou DB
   CREATE USER core_app WITH PASSWORD 'strong_password_1';
   CREATE USER keycloak_app WITH PASSWORD 'strong_password_2';
   CREATE USER grafana_app WITH PASSWORD 'strong_password_3';
   
   GRANT ALL ON DATABASE core TO core_app;
   GRANT ALL ON DATABASE keycloak TO keycloak_app;
   GRANT ALL ON DATABASE grafana TO grafana_app;
   ```

5. âš ï¸ **PÅ™idat Redis authentication**
   ```yaml
   # docker/docker-compose.yml
   redis:
     command: redis-server --requirepass ${REDIS_PASSWORD}
   ```
   ```bash
   # .env.template
   REDIS_PASSWORD=<generate_strong_password>
   ```

6. âš ï¸ **Rotovat vÅ¡echny credentials**
   - NovÃ½ `KEYCLOAK_ADMIN_CLIENT_SECRET`
   - NovÃ© DB passwords
   - NovÃ½ `GRAFANA_ADMIN_PASSWORD`

### Priorita 3 (PÅ™Ã­Å¡tÃ­ mÄ›sÃ­c) - LONG-TERM
7. ğŸ”„ **Migrovat na Docker Secrets**
   ```yaml
   secrets:
     db_password:
       file: ./secrets/db_password.txt
   
   services:
     backend:
       secrets:
         - db_password
       environment:
         DATABASE_PASSWORD_FILE: /run/secrets/db_password
   ```

8. ğŸ”„ **Implementovat secret rotation strategy**
   - Automated credential rotation (90 days)
   - Audit logging pro access k secrets
   - Vault integration (HashiCorp Vault / AWS Secrets Manager)

9. ğŸ”„ **Kafka SASL_SSL encryption**
   ```yaml
   kafka:
     environment:
       KAFKA_SECURITY_PROTOCOL: SASL_SSL
       KAFKA_SASL_MECHANISM: PLAIN
   ```

10. ğŸ”„ **Code audit findings documentation**
    - PÅ™idat tento audit do onboarding docs
    - CI/CD check pro hardcoded credentials
    - Pre-commit hook na `.env` leak detection

---

## ğŸ“„ APPENDIX: File Locations Reference

```
Environment Sources:
â”œâ”€â”€ .env.template                      (MASTER - 47 variables)
â”œâ”€â”€ .env                              (Generated copy)
â”œâ”€â”€ docker-compose.template.yml        (Service definitions)
â””â”€â”€ backend/src/main/resources/
    â”œâ”€â”€ application.yml               (Backend config)
    â””â”€â”€ application-reporting.yml     (Reporting config)

Generated Files (Build Time):
â”œâ”€â”€ docker-compose.yml                (From template)
â”œâ”€â”€ docker/keycloak/realm-admin.json  (From template + envsubst)
â””â”€â”€ docker/nginx/nginx-ssl.conf       (From template + envsubst)

Secrets Storage:
â”œâ”€â”€ .env                              (All secrets plain-text!)
â”œâ”€â”€ docker/ssl/server.key.pem         (SSL private key)
â””â”€â”€ docker/keycloak/realm-admin.json  (Client secrets)

Runtime Containers:
â”œâ”€â”€ core-db           (PostgreSQL - 3 databases)
â”œâ”€â”€ core-keycloak     (Auth server)
â”œâ”€â”€ core-backend      (Spring Boot app)
â”œâ”€â”€ core-frontend     (Static files via Nginx)
â”œâ”€â”€ core-redis        (Cache)
â”œâ”€â”€ core-kafka        (Events)
â”œâ”€â”€ core-minio        (S3 storage)
â””â”€â”€ core-grafana      (Monitoring)
```

---

**Tento audit mapuje 100% secrets, credentials a konfiguracÃ­ v projektu.**

Pokud potÅ™ebujeÅ¡ detailnÄ›jÅ¡Ã­ analÃ½zu konkrÃ©tnÃ­ oblasti (napÅ™. "jak pÅ™esnÄ› funguje JWT validation" nebo "trace KEYCLOAK_ADMIN_CLIENT_SECRET od source k runtime"), Å™ekni mi!
