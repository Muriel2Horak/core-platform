# S1: Authelia Authentication Gateway

> **Security Layer:** Authelia deployment with Redis sessions, OIDC client, 2FA support

## ðŸ“‹ Story

**As a** platform administrator  
**I want** Authelia authentication gateway deployed  
**So that** n8n UI is protected by SSO with 2FA capability

## ðŸŽ¯ Acceptance Criteria

**GIVEN** user accesses n8n UI  
**WHEN** not authenticated  
**THEN** redirected to Authelia login page  
**AND** after Keycloak SSO login, redirected back to n8n  
**AND** session stored in Redis with 1h expiration

**GIVEN** admin user enabled 2FA  
**WHEN** logging in  
**THEN** prompted for TOTP code after password  
**AND** login fails with invalid TOTP

## ðŸ—ï¸ Implementation

### Docker Compose Configuration

```yaml
# docker/docker-compose.authelia.yml
version: '3.8'

services:
  authelia:
    image: authelia/authelia:4.38
    container_name: core-authelia
    restart: unless-stopped
    environment:
      - TZ=Europe/Prague
      - AUTHELIA_JWT_SECRET_FILE=/run/secrets/authelia_jwt_secret
      - AUTHELIA_SESSION_SECRET_FILE=/run/secrets/authelia_session_secret
      - AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE=/run/secrets/authelia_storage_encryption_key
      - AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET_FILE=/run/secrets/authelia_oidc_hmac_secret
      - AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY_FILE=/run/secrets/authelia_oidc_private_key
      - AUTHELIA_REDIS_PASSWORD=${AUTHELIA_REDIS_PASSWORD}
    volumes:
      - ./authelia/configuration.yml:/config/configuration.yml:ro
      - ./authelia/users_database.yml:/config/users_database.yml:ro
      - authelia_data:/config
    secrets:
      - authelia_jwt_secret
      - authelia_session_secret
      - authelia_storage_encryption_key
      - authelia_oidc_hmac_secret
      - authelia_oidc_private_key
    networks:
      - core-network
    expose:
      - 9091
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9091/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  authelia_redis:
    image: redis:7.2-alpine
    container_name: core-authelia-redis
    restart: unless-stopped
    command: redis-server --requirepass ${AUTHELIA_REDIS_PASSWORD}
    volumes:
      - authelia_redis_data:/data
    networks:
      - core-network
    expose:
      - 6379
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

secrets:
  authelia_jwt_secret:
    file: ./secrets/authelia_jwt_secret.txt
  authelia_session_secret:
    file: ./secrets/authelia_session_secret.txt
  authelia_storage_encryption_key:
    file: ./secrets/authelia_storage_encryption_key.txt
  authelia_oidc_hmac_secret:
    file: ./secrets/authelia_oidc_hmac_secret.txt
  authelia_oidc_private_key:
    file: ./secrets/authelia_oidc_private_key.pem

volumes:
  authelia_data:
    driver: local
  authelia_redis_data:
    driver: local

networks:
  core-network:
    external: true
```

### Authelia Configuration

```yaml
# docker/authelia/configuration.yml
---
theme: auto
default_2fa_method: totp

server:
  host: 0.0.0.0
  port: 9091
  path: ""
  enable_pprof: false
  enable_expvars: false

log:
  level: info
  format: json
  file_path: ""

totp:
  disable: false
  issuer: core-platform.local
  algorithm: sha1
  digits: 6
  period: 30
  skew: 1
  secret_size: 32

webauthn:
  disable: false
  display_name: Core Platform
  attestation_conveyance_preference: indirect
  user_verification: preferred
  timeout: 60s

authentication_backend:
  password_reset:
    disable: false
  refresh_interval: 5m
  
  ldap:
    implementation: custom
    url: ldap://keycloak:389
    timeout: 5s
    start_tls: false
    base_dn: dc=core-platform,dc=local
    username_attribute: uid
    additional_users_dn: ou=users
    users_filter: (&({username_attribute}={input})(objectClass=person))
    additional_groups_dn: ou=groups
    groups_filter: (&(member={dn})(objectClass=groupOfNames))
    group_name_attribute: cn
    mail_attribute: mail
    display_name_attribute: displayName
    user: cn=admin,dc=core-platform,dc=local
    password: ${LDAP_PASSWORD}

session:
  name: authelia_session
  domain: core-platform.local
  secret: file:///run/secrets/authelia_session_secret
  expiration: 1h
  inactivity: 5m
  remember_me_duration: 1M
  
  redis:
    host: authelia_redis
    port: 6379
    password: ${AUTHELIA_REDIS_PASSWORD}
    database_index: 0
    maximum_active_connections: 10
    minimum_idle_connections: 0

regulation:
  max_retries: 3
  find_time: 2m
  ban_time: 10m

storage:
  encryption_key: file:///run/secrets/authelia_storage_encryption_key
  local:
    path: /config/db.sqlite3

notifier:
  disable_startup_check: false
  filesystem:
    filename: /config/notification.txt

access_control:
  default_policy: deny
  
  rules:
    # Health checks bypass auth
    - domain: "core-platform.local"
      policy: bypass
      resources:
        - "^/health$"
        - "^/api/health$"
    
    # n8n webhooks bypass auth (public integrations)
    - domain: "core-platform.local"
      policy: bypass
      resources:
        - "^/n8n/webhook/.*$"
        - "^/n8n/webhook-test/.*$"
    
    # Admin workflows require 2FA
    - domain: "core-platform.local"
      policy: two_factor
      subject:
        - ["group:n8n-admins"]
      resources:
        - "^/n8n/workflows/.*$"
        - "^/n8n/executions/.*$"
        - "^/n8n/settings/.*$"
    
    # Regular users need 1FA
    - domain: "core-platform.local"
      policy: one_factor
      subject:
        - ["group:n8n-users"]
      resources:
        - "^/n8n/.*$"
    
    # Viewers read-only with 1FA
    - domain: "core-platform.local"
      policy: one_factor
      subject:
        - ["group:n8n-viewers"]
      resources:
        - "^/n8n/workflows$"
        - "^/n8n/executions$"

identity_providers:
  oidc:
    hmac_secret: file:///run/secrets/authelia_oidc_hmac_secret
    issuer_private_key: file:///run/secrets/authelia_oidc_private_key
    
    access_token_lifespan: 1h
    authorize_code_lifespan: 1m
    id_token_lifespan: 1h
    refresh_token_lifespan: 90d
    
    enable_client_debug_messages: false
    minimum_parameter_entropy: 8
    
    cors:
      endpoints:
        - authorization
        - token
        - revocation
        - introspection
      allowed_origins:
        - https://core-platform.local
      allowed_origins_from_client_redirect_uris: true
    
    clients:
      - id: n8n-workflow-engine
        description: n8n Workflow Automation Platform
        secret: "$pbkdf2-sha512$310000$c8p78n7pUMln0jzvd4aK4Q$JNRBzwAo0ek5qKn50cFzzvE9RXV88h1wJn5KGiHCHoA"  # CHANGE ME!
        public: false
        authorization_policy: two_factor
        
        redirect_uris:
          - https://core-platform.local/n8n/rest/oauth2-credential/callback
          - https://core-platform.local/authelia/callback
        
        scopes:
          - openid
          - profile
          - email
          - groups
        
        grant_types:
          - authorization_code
          - refresh_token
        
        response_types:
          - code
        
        response_modes:
          - form_post
          - query
          - fragment
        
        userinfo_signing_algorithm: none
```

### Secret Generation Script

```bash
#!/bin/bash
# scripts/generate_authelia_secrets.sh

set -e

SECRETS_DIR="docker/secrets"
mkdir -p "$SECRETS_DIR"

echo "ðŸ” Generating Authelia secrets..."

# JWT Secret (64 chars)
if [ ! -f "$SECRETS_DIR/authelia_jwt_secret.txt" ]; then
    openssl rand -base64 64 | tr -d '\n' > "$SECRETS_DIR/authelia_jwt_secret.txt"
    echo "âœ… Generated authelia_jwt_secret.txt"
fi

# Session Secret (64 chars)
if [ ! -f "$SECRETS_DIR/authelia_session_secret.txt" ]; then
    openssl rand -base64 64 | tr -d '\n' > "$SECRETS_DIR/authelia_session_secret.txt"
    echo "âœ… Generated authelia_session_secret.txt"
fi

# Storage Encryption Key (64 chars)
if [ ! -f "$SECRETS_DIR/authelia_storage_encryption_key.txt" ]; then
    openssl rand -base64 64 | tr -d '\n' > "$SECRETS_DIR/authelia_storage_encryption_key.txt"
    echo "âœ… Generated authelia_storage_encryption_key.txt"
fi

# OIDC HMAC Secret (64 chars)
if [ ! -f "$SECRETS_DIR/authelia_oidc_hmac_secret.txt" ]; then
    openssl rand -base64 64 | tr -d '\n' > "$SECRETS_DIR/authelia_oidc_hmac_secret.txt"
    echo "âœ… Generated authelia_oidc_hmac_secret.txt"
fi

# OIDC RSA Key Pair (2048-bit)
if [ ! -f "$SECRETS_DIR/authelia_oidc_private_key.pem" ]; then
    openssl genrsa -out "$SECRETS_DIR/authelia_oidc_private_key.pem" 2048
    openssl rsa -in "$SECRETS_DIR/authelia_oidc_private_key.pem" \
                -pubout -out "$SECRETS_DIR/authelia_oidc_public_key.pem"
    echo "âœ… Generated OIDC RSA key pair"
fi

# n8n OIDC Client Secret (for Keycloak)
if [ ! -f "$SECRETS_DIR/n8n_oidc_client_secret.txt" ]; then
    CLIENT_SECRET=$(openssl rand -base64 32 | tr -d '\n')
    echo "$CLIENT_SECRET" > "$SECRETS_DIR/n8n_oidc_client_secret.txt"
    echo "âœ… Generated n8n_oidc_client_secret.txt"
    echo ""
    echo "âš ï¸  IMPORTANT: Save this client secret for Keycloak configuration:"
    echo "   Client Secret: $CLIENT_SECRET"
    echo ""
    echo "ðŸ”’ Now hash this secret for Authelia configuration.yml:"
    echo "   Run: docker run --rm authelia/authelia:latest authelia crypto hash generate pbkdf2 --password \"$CLIENT_SECRET\""
fi

echo ""
echo "âœ… All secrets generated in $SECRETS_DIR"
echo "ðŸ”’ NEVER commit these files to Git!"
echo "ðŸ“‹ Next steps:"
echo "   1. Hash client secret for Authelia"
echo "   2. Update configuration.yml with hashed secret"
echo "   3. Create n8n client in Keycloak with client secret"
echo "   4. Start Authelia: docker-compose -f docker/docker-compose.authelia.yml up -d"
```

### Hash Client Secret Script

```bash
#!/bin/bash
# scripts/hash_authelia_client_secret.sh

set -e

SECRETS_DIR="docker/secrets"
CLIENT_SECRET_FILE="$SECRETS_DIR/n8n_oidc_client_secret.txt"

if [ ! -f "$CLIENT_SECRET_FILE" ]; then
    echo "âŒ Error: $CLIENT_SECRET_FILE not found!"
    echo "   Run: ./scripts/generate_authelia_secrets.sh first"
    exit 1
fi

CLIENT_SECRET=$(cat "$CLIENT_SECRET_FILE")

echo "ðŸ” Hashing client secret for Authelia configuration..."
echo ""

HASHED_SECRET=$(docker run --rm authelia/authelia:latest \
    authelia crypto hash generate pbkdf2 --password "$CLIENT_SECRET" 2>&1 | grep "Digest:" | awk '{print $2}')

echo "âœ… Hashed secret (copy to configuration.yml):"
echo ""
echo "  clients:"
echo "    - id: n8n-workflow-engine"
echo "      secret: \"$HASHED_SECRET\""
echo ""
echo "ðŸ“‹ Original secret (for Keycloak client configuration):"
echo "   $CLIENT_SECRET"
```

## ðŸ“Š Production Metrics

- **Deployment time:** <5 minutes
- **Auth latency:** <200ms P95
- **Session storage:** Redis (100k+ sessions)
- **2FA adoption:** 90% admin users within 30 days
- **Availability:** 99.9% (Authelia + Redis combined)
- **Security:** 0 bypass except webhooks + health checks

---

**Story Points:** 3  
**Estimate:** 800 LOC  
**Dependencies:** Docker, Redis, Keycloak (EPIC-003)
