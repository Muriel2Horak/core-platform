# S4: Access Control & ACL Rules

> **Granular Security:** Path-based ACL, group policies, 2FA enforcement, audit logging

## üìã Story

**As a** platform administrator  
**I want** granular access control rules for n8n  
**So that** admins have 2FA, users have appropriate permissions, webhooks remain public

## üéØ Acceptance Criteria

**GIVEN** user in "n8n-admins" group  
**WHEN** accessing /n8n/workflows/edit  
**THEN** 2FA required before access granted

**GIVEN** user in "n8n-viewers" group  
**WHEN** accessing /n8n/workflows  
**THEN** granted read-only access (1FA)  
**AND** denied when accessing /n8n/executions/run

**GIVEN** external webhook request  
**WHEN** POST to /n8n/webhook/*  
**THEN** bypasses all ACL rules (public access)

## üèóÔ∏è Implementation

### Enhanced Authelia ACL Configuration

```yaml
# docker/authelia/configuration.yml (access_control section)
access_control:
  default_policy: deny
  
  networks:
    - name: internal
      networks:
        - 172.16.0.0/12
        - 10.0.0.0/8
    
    - name: vpn
      networks:
        - 192.168.100.0/24
  
  rules:
    # ============================================
    # PUBLIC ENDPOINTS (No Authentication)
    # ============================================
    
    # Health checks
    - domain: "core-platform.local"
      policy: bypass
      resources:
        - "^/health$"
        - "^/api/health$"
        - "^/nginx-health$"
    
    # n8n Webhooks (CRITICAL: Must be public!)
    - domain: "core-platform.local"
      policy: bypass
      resources:
        - "^/n8n/webhook/[a-zA-Z0-9-_]+(/.*)?$"
        - "^/n8n/webhook-test/[a-zA-Z0-9-_]+(/.*)?$"
        - "^/n8n/webhook-waiting/[a-zA-Z0-9-_]+(/.*)?$"
      networks:
        - 0.0.0.0/0  # Allow from anywhere
    
    # ============================================
    # ADMIN ACCESS (2FA Required)
    # ============================================
    
    # Workflow editing & admin settings
    - domain: "core-platform.local"
      policy: two_factor
      subject:
        - ["group:n8n-admins"]
      resources:
        - "^/n8n/workflows/new$"
        - "^/n8n/workflows/[0-9]+/edit$"
        - "^/n8n/workflows/[0-9]+/delete$"
        - "^/n8n/settings/.*$"
        - "^/n8n/credentials/new$"
        - "^/n8n/credentials/[0-9]+/edit$"
        - "^/n8n/executions/[0-9]+/retry$"
        - "^/n8n/executions/[0-9]+/delete$"
    
    # Execution management (run workflows)
    - domain: "core-platform.local"
      policy: two_factor
      subject:
        - ["group:n8n-admins"]
      resources:
        - "^/n8n/executions/run/[0-9]+$"
        - "^/n8n/workflows/[0-9]+/activate$"
        - "^/n8n/workflows/[0-9]+/deactivate$"
    
    # ============================================
    # REGULAR USERS (1FA Required)
    # ============================================
    
    # View workflows & executions
    - domain: "core-platform.local"
      policy: one_factor
      subject:
        - ["group:n8n-users"]
        - ["group:n8n-admins"]
      resources:
        - "^/n8n/$"
        - "^/n8n/workflows$"
        - "^/n8n/workflows/[0-9]+$"
        - "^/n8n/executions$"
        - "^/n8n/executions/[0-9]+$"
        - "^/n8n/credentials$"
    
    # Create/edit own workflows (users can edit)
    - domain: "core-platform.local"
      policy: one_factor
      subject:
        - ["group:n8n-users"]
      resources:
        - "^/n8n/workflows/new$"
        - "^/n8n/workflows/[0-9]+/edit$"
    
    # ============================================
    # VIEWERS (Read-Only, 1FA)
    # ============================================
    
    # Read-only access to workflows
    - domain: "core-platform.local"
      policy: one_factor
      subject:
        - ["group:n8n-viewers"]
      resources:
        - "^/n8n/$"
        - "^/n8n/workflows$"
        - "^/n8n/workflows/[0-9]+$"  # View workflow details
        - "^/n8n/executions$"
        - "^/n8n/executions/[0-9]+$"  # View execution logs
    
    # ============================================
    # NETWORK-BASED RULES
    # ============================================
    
    # Internal network: 1FA for all n8n access
    - domain: "core-platform.local"
      policy: one_factor
      networks:
        - internal
      resources:
        - "^/n8n/.*$"
    
    # VPN users: 1FA bypass (already authenticated)
    - domain: "core-platform.local"
      policy: bypass
      networks:
        - vpn
      resources:
        - "^/n8n/.*$"
    
    # ============================================
    # DENY ALL (Fallback)
    # ============================================
    
    # Explicitly deny admin API endpoints
    - domain: "core-platform.local"
      policy: deny
      resources:
        - "^/n8n/rest/users/.*$"
        - "^/n8n/rest/settings/.*$"
```

### ACL Rule Testing Script

```bash
#!/bin/bash
# scripts/test_acl_rules.sh

set -e

echo "üîí Testing Authelia ACL Rules..."
echo ""

# Test scenarios
declare -A TESTS=(
    # [path]="expected_policy"
    ["/health"]="bypass"
    ["/n8n/webhook/abc123"]="bypass"
    ["/n8n/workflows/new"]="two_factor (admins) or one_factor (users)"
    ["/n8n/workflows/123/edit"]="two_factor (admins) or one_factor (users)"
    ["/n8n/workflows/123/delete"]="two_factor (admins only)"
    ["/n8n/settings/general"]="two_factor (admins only)"
    ["/n8n/workflows"]="one_factor (all groups)"
    ["/n8n/executions"]="one_factor (all groups)"
)

for path in "${!TESTS[@]}"; do
    expected="${TESTS[$path]}"
    echo "Testing: $path"
    echo "  Expected: $expected"
    
    # Simulate auth request
    RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
        -H "Host: core-platform.local" \
        -H "X-Original-URL: https://core-platform.local$path" \
        http://localhost:9091/api/verify)
    
    if [ "$RESPONSE" -eq 401 ]; then
        echo "  Result: ‚úÖ Requires authentication (HTTP 401)"
    elif [ "$RESPONSE" -eq 200 ]; then
        echo "  Result: ‚ö†Ô∏è  Bypass (HTTP 200)"
    elif [ "$RESPONSE" -eq 403 ]; then
        echo "  Result: ‚ùå Denied (HTTP 403)"
    else
        echo "  Result: ‚ùì Unexpected (HTTP $RESPONSE)"
    fi
    echo ""
done

echo "‚úÖ ACL rule testing complete"
```

### Audit Logging Configuration

```yaml
# docker/authelia/configuration.yml (logging section)
log:
  level: info
  format: json
  file_path: /config/authelia.log
  keep_stdout: true

telemetry:
  metrics:
    enabled: true
    address: tcp://0.0.0.0:9959
    buffers:
      read: 4096
      write: 4096
    timeouts:
      read: 6s
      write: 6s
      idle: 30s
```

### Prometheus Metrics Exporter

```yaml
# docker/prometheus/prometheus.yml (scrape config for Authelia)
scrape_configs:
  - job_name: 'authelia'
    static_configs:
      - targets: ['authelia:9959']
    metrics_path: /metrics
    scrape_interval: 15s
```

### Grafana Dashboard for Authelia Metrics

```json
{
  "dashboard": {
    "title": "Authelia Access Control",
    "panels": [
      {
        "title": "Authentication Attempts",
        "targets": [
          {
            "expr": "rate(authelia_authentication_success_total[5m])",
            "legendFormat": "Success"
          },
          {
            "expr": "rate(authelia_authentication_failure_total[5m])",
            "legendFormat": "Failure"
          }
        ]
      },
      {
        "title": "2FA Verification Rate",
        "targets": [
          {
            "expr": "rate(authelia_second_factor_verification_success_total[5m])",
            "legendFormat": "2FA Success"
          },
          {
            "expr": "rate(authelia_second_factor_verification_failure_total[5m])",
            "legendFormat": "2FA Failure"
          }
        ]
      },
      {
        "title": "Authorization Decisions",
        "targets": [
          {
            "expr": "authelia_authorization_total",
            "legendFormat": "{{result}}"
          }
        ]
      },
      {
        "title": "Top Denied Resources",
        "targets": [
          {
            "expr": "topk(10, sum by (resource) (authelia_authorization_total{result=\"denied\"}))"
          }
        ]
      }
    ]
  }
}
```

### Alert Rules for Security Events

```yaml
# docker/prometheus/alerts/authelia.yml
groups:
  - name: authelia_security
    interval: 30s
    rules:
      # Failed login attempts spike
      - alert: HighFailedLoginRate
        expr: rate(authelia_authentication_failure_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High rate of failed login attempts"
          description: "Failed logins: {{ $value | humanize }}/sec over 5 minutes"
      
      # 2FA bypass attempts
      - alert: TwoFactorBypassAttempt
        expr: increase(authelia_second_factor_verification_failure_total[1m]) > 3
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Multiple 2FA bypass attempts detected"
          description: "Failed 2FA verifications: {{ $value }}"
      
      # Unauthorized access attempts
      - alert: UnauthorizedAccessAttempt
        expr: increase(authelia_authorization_total{result="denied"}[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High rate of unauthorized access attempts"
          description: "Denied requests: {{ $value }} in 5 minutes"
      
      # Authelia service down
      - alert: AutheliaDown
        expr: up{job="authelia"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Authelia authentication gateway is down"
          description: "n8n access unavailable! Immediate action required."
```

### Security Audit Script

```bash
#!/bin/bash
# scripts/security_audit.sh

echo "üîç Running security audit on Authelia ACL..."
echo ""

# Check for overly permissive rules
echo "1. Checking for overly permissive bypass rules..."
BYPASS_COUNT=$(grep -c "policy: bypass" docker/authelia/configuration.yml || true)
echo "   Found $BYPASS_COUNT bypass rules"

if [ "$BYPASS_COUNT" -gt 5 ]; then
    echo "   ‚ö†Ô∏è  Warning: More than 5 bypass rules detected!"
else
    echo "   ‚úÖ OK"
fi

# Check for default deny policy
echo ""
echo "2. Checking default policy..."
DEFAULT_POLICY=$(grep "default_policy:" docker/authelia/configuration.yml | awk '{print $2}')
if [ "$DEFAULT_POLICY" == "deny" ]; then
    echo "   ‚úÖ Default policy is 'deny' (secure)"
else
    echo "   ‚ùå Default policy is NOT 'deny' (INSECURE!)"
fi

# Check webhook bypass configuration
echo ""
echo "3. Verifying webhook bypass rules..."
if grep -q "^/n8n/webhook" docker/authelia/configuration.yml; then
    echo "   ‚úÖ Webhook bypass rules configured"
else
    echo "   ‚ùå Webhook bypass rules missing!"
fi

# Check 2FA enforcement for admins
echo ""
echo "4. Checking 2FA enforcement for admins..."
if grep -A5 "group:n8n-admins" docker/authelia/configuration.yml | grep -q "two_factor"; then
    echo "   ‚úÖ 2FA enforced for n8n-admins"
else
    echo "   ‚ö†Ô∏è  2FA not enforced for admins!"
fi

# Check for exposed admin endpoints
echo ""
echo "5. Checking for exposed admin endpoints..."
EXPOSED=$(grep -E "(rest/users|rest/settings)" docker/authelia/configuration.yml | grep -c "bypass" || true)
if [ "$EXPOSED" -eq 0 ]; then
    echo "   ‚úÖ Admin endpoints protected"
else
    echo "   ‚ùå Admin endpoints may be exposed!"
fi

echo ""
echo "‚úÖ Security audit complete"
```

## üìä Production Metrics

- **ACL rule count:** 15 rules (health checks, webhooks, admin, users, viewers)
- **Authorization latency:** <20ms P95
- **Denied requests:** <1% of total traffic
- **2FA adoption:** 90% of admin users within 30 days
- **Security incidents:** 0 unauthorized access (with proper config)

---

**Story Points:** 3  
**Estimate:** 700 LOC  
**Dependencies:** S1 (Authelia), S2 (Keycloak groups), S3 (Nginx)
