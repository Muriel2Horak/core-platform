# S3: Nginx Forward Auth Configuration

> **Reverse Proxy:** SSL termination, forward auth to Authelia, webhook bypass, rate limiting

## üìã Story

**As a** platform administrator  
**I want** Nginx configured as reverse proxy with forward auth  
**So that** all n8n UI traffic goes through Authelia, but webhooks remain publicly accessible

## üéØ Acceptance Criteria

**GIVEN** user accesses https://core-platform.local/n8n/  
**WHEN** not authenticated  
**THEN** Nginx forwards auth request to Authelia  
**AND** Authelia redirects to login  
**AND** after auth, request proxied to n8n

**GIVEN** external service sends webhook  
**WHEN** POST to /n8n/webhook/test-webhook  
**THEN** bypasses auth (no Authelia check)  
**AND** directly proxied to n8n  
**AND** receives 200 OK

## üèóÔ∏è Implementation

### Nginx Configuration

```nginx
# docker/nginx/sites-enabled/n8n.conf

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=webhook_limit:10m rate=100r/s;

# Upstream: Authelia
upstream authelia {
    server authelia:9091;
}

# Upstream: n8n
upstream n8n {
    server n8n:5678;
}

server {
    listen 443 ssl http2;
    server_name core-platform.local;

    # SSL Configuration
    ssl_certificate /etc/nginx/ssl/server.crt.pem;
    ssl_certificate_key /etc/nginx/ssl/server.key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Access Logs
    access_log /var/log/nginx/n8n_access.log;
    error_log /var/log/nginx/n8n_error.log warn;

    # Health check (bypass auth)
    location = /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # Authelia endpoint
    location /authelia {
        proxy_pass http://authelia;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # n8n Webhooks (NO AUTH - public access)
    location ~ ^/n8n/webhook(?:-test)?/ {
        limit_req zone=webhook_limit burst=20 nodelay;
        
        # Log webhook hits
        access_log /var/log/nginx/n8n_webhooks.log;
        
        # Proxy to n8n
        proxy_pass http://n8n;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # No auth required!
        # No auth_request directive here
    }

    # n8n UI (AUTH REQUIRED via Authelia)
    location /n8n/ {
        limit_req zone=auth_limit burst=5 nodelay;

        # Forward auth to Authelia
        auth_request /authelia-verify;
        auth_request_set $user $upstream_http_remote_user;
        auth_request_set $groups $upstream_http_remote_groups;
        auth_request_set $name $upstream_http_remote_name;
        auth_request_set $email $upstream_http_remote_email;
        
        # On auth failure, redirect to Authelia
        error_page 401 = @authelia_redirect;

        # Proxy to n8n
        proxy_pass http://n8n;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        
        # Pass user info to n8n
        proxy_set_header Remote-User $user;
        proxy_set_header Remote-Groups $groups;
        proxy_set_header Remote-Name $name;
        proxy_set_header Remote-Email $email;
        
        # WebSocket support (for n8n editor)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts for long-running workflows
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Authelia verification endpoint (internal)
    location = /authelia-verify {
        internal;
        
        proxy_pass http://authelia/api/verify;
        proxy_set_header Host $host;
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        proxy_set_header X-Forwarded-Method $request_method;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Uri $request_uri;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Content-Length "";
        proxy_pass_request_body off;
        
        # Fast timeouts for auth checks
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }

    # Redirect to Authelia login
    location @authelia_redirect {
        return 302 https://$host/authelia/?rd=$scheme://$host$request_uri;
    }

    # Root redirect to n8n
    location = / {
        return 302 https://$host/n8n/;
    }
}

# HTTP to HTTPS redirect
server {
    listen 80;
    server_name core-platform.local;
    
    # Health check (direct, no redirect)
    location = /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
    
    # Webhooks (allow HTTP for legacy integrations)
    location ~ ^/n8n/webhook(?:-test)?/ {
        proxy_pass http://n8n;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;
    }
    
    # All other traffic: redirect to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}
```

### Nginx Dockerfile

```dockerfile
# docker/nginx/Dockerfile
FROM nginx:1.25-alpine

# Install dependencies
RUN apk add --no-cache \
    bash \
    curl \
    openssl

# Copy SSL certificates
COPY ssl/server.crt.pem /etc/nginx/ssl/
COPY ssl/server.key.pem /etc/nginx/ssl/

# Copy Nginx configuration
COPY nginx/nginx.conf /etc/nginx/nginx.conf
COPY nginx/sites-enabled/ /etc/nginx/sites-enabled/

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD curl -f http://localhost/health || exit 1

EXPOSE 80 443

CMD ["nginx", "-g", "daemon off;"]
```

### Docker Compose Integration

```yaml
# docker/docker-compose.authelia.yml (nginx service)
services:
  nginx:
    build:
      context: .
      dockerfile: nginx/Dockerfile
    container_name: core-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/sites-enabled:/etc/nginx/sites-enabled:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - core-network
    depends_on:
      - authelia
      - n8n
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  nginx_logs:
    driver: local
```

### Test Scripts

```bash
#!/bin/bash
# scripts/test_nginx_auth.sh

set -e

echo "üß™ Testing Nginx Forward Auth Configuration..."
echo ""

# Test 1: Health check (bypass auth)
echo "Test 1: Health check (no auth)"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/health)
if [ "$RESPONSE" -eq 200 ]; then
    echo "‚úÖ Health check works (HTTP $RESPONSE)"
else
    echo "‚ùå Health check failed (HTTP $RESPONSE)"
fi

# Test 2: n8n UI without auth (should redirect to Authelia)
echo ""
echo "Test 2: n8n UI without auth"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -L http://localhost/n8n/)
if [ "$RESPONSE" -eq 200 ]; then
    LOCATION=$(curl -s -I http://localhost/n8n/ | grep -i "location:" | awk '{print $2}' | tr -d '\r')
    if [[ "$LOCATION" == *"authelia"* ]]; then
        echo "‚úÖ Redirects to Authelia ($LOCATION)"
    else
        echo "‚ö†Ô∏è  Unexpected redirect: $LOCATION"
    fi
else
    echo "‚ùå Unexpected response (HTTP $RESPONSE)"
fi

# Test 3: Webhook (no auth)
echo ""
echo "Test 3: Webhook without auth (should work)"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
    -X POST http://localhost/n8n/webhook/test-webhook \
    -H "Content-Type: application/json" \
    -d '{"test": "data"}')

if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 404 ]; then
    echo "‚úÖ Webhook accessible without auth (HTTP $RESPONSE)"
else
    echo "‚ùå Webhook blocked (HTTP $RESPONSE)"
fi

# Test 4: HTTPS redirect
echo ""
echo "Test 4: HTTP to HTTPS redirect"
LOCATION=$(curl -s -I http://localhost/ | grep -i "location:" | awk '{print $2}' | tr -d '\r')
if [[ "$LOCATION" == "https://"* ]]; then
    echo "‚úÖ HTTP redirects to HTTPS ($LOCATION)"
else
    echo "‚ùå No HTTPS redirect (Location: $LOCATION)"
fi

echo ""
echo "‚úÖ All tests completed!"
```

```bash
#!/bin/bash
# scripts/test_webhook_performance.sh

echo "‚ö° Testing webhook rate limiting..."

# Send 30 requests (limit is 100/sec with burst 20)
for i in {1..30}; do
    RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
        -X POST http://localhost/n8n/webhook/test \
        -H "Content-Type: application/json" \
        -d "{\"request\": $i}")
    
    if [ "$RESPONSE" -eq 429 ]; then
        echo "Request $i: ‚ö†Ô∏è  Rate limited (HTTP 429)"
    elif [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 404 ]; then
        echo "Request $i: ‚úÖ OK (HTTP $RESPONSE)"
    else
        echo "Request $i: ‚ùå Error (HTTP $RESPONSE)"
    fi
done
```

### Monitoring Script

```bash
#!/bin/bash
# scripts/monitor_nginx_logs.sh

echo "üìä Monitoring Nginx logs..."
echo ""

# Watch access logs
tail -f docker/volumes/nginx_logs/n8n_access.log &
ACCESS_PID=$!

# Watch webhook logs
tail -f docker/volumes/nginx_logs/n8n_webhooks.log &
WEBHOOK_PID=$!

# Watch error logs
tail -f docker/volumes/nginx_logs/n8n_error.log &
ERROR_PID=$!

echo "‚úÖ Monitoring started"
echo "   Access logs: PID $ACCESS_PID"
echo "   Webhook logs: PID $WEBHOOK_PID"
echo "   Error logs: PID $ERROR_PID"
echo ""
echo "Press Ctrl+C to stop..."

# Wait for Ctrl+C
trap "kill $ACCESS_PID $WEBHOOK_PID $ERROR_PID; exit 0" SIGINT
wait
```

## üìä Production Metrics

- **Proxy overhead:** <100ms P95
- **Auth check latency:** <50ms P95 (to Authelia)
- **Webhook throughput:** 100 req/sec sustained
- **SSL handshake:** <200ms P95
- **Request volume:** 1M+ requests/day
- **Error rate:** <0.1% (excluding 401/403)

---

**Story Points:** 3  
**Estimate:** 600 LOC  
**Dependencies:** S1 (Authelia), SSL certificates, n8n deployment (S5)
