# S9: Reporting Dashboards (Cube.js Analytics)

**EPIC:** [EPIC-003: Monitoring & Observability](../README.md)  
**Status:** ðŸ”µ **TODO**  
**Priority:** P1  
**LOC:** ~1,800 Å™Ã¡dkÅ¯ (Cube.js schema + React components)  
**Effort:** ~16 hodin

---

## ðŸ“‹ Story Description

Jako **business analyst / CFO**, chci **reporting dashboardy s pokroÄilou analytikou (Cube.js)**, abych **vidÄ›l revenue trends, usage patterns, compliance metrics a mohl generovat executive reports**.

---

## ðŸŽ¯ Acceptance Criteria

### AC1: Revenue Dashboard
- **GIVEN** `/admin/reports/revenue`
- **WHEN** zobrazÃ­m dashboard
- **THEN** vidÃ­m:
  - **MRR** (Monthly Recurring Revenue) - trend
  - **ARR** (Annual Recurring Revenue) - YoY growth
  - **Revenue by Plan** (pie chart)
  - **Churn Rate** (%)
  - **ARPU** (Average Revenue Per User)
  - **LTV** (Lifetime Value) by cohort
  - **Forecast** (next 3 months)

### AC2: Usage Reports
- **GIVEN** `/admin/reports/usage`
- **WHEN** zobrazÃ­m dashboard
- **THEN** vidÃ­m:
  - **Active Users** (DAU, WAU, MAU)
  - **Feature Adoption** (% users using feature)
  - **Storage Consumption** (by tenant, over time)
  - **API Usage** (calls per tenant, rate limits)
  - **Document Volume** (created/updated/deleted)
  - **Workflow Executions** (n8n stats)

### AC3: Compliance Reports
- **GIVEN** `/admin/reports/compliance`
- **WHEN** zobrazÃ­m dashboard
- **THEN** vidÃ­m:
  - **Audit Logs Coverage** (% actions logged)
  - **Data Retention** (days stored, policy compliance)
  - **Access Control** (users with elevated permissions)
  - **Failed Login Attempts** (potential security issues)
  - **Data Exports** (who, when, what)
  - **GDPR Compliance** (right to be forgotten requests)

### AC4: Executive Summary
- **GIVEN** `/admin/reports/executive`
- **WHEN** zobrazÃ­m dashboard
- **THEN** vidÃ­m:
  - **Key Metrics** (top 6 KPIs)
  - **Health Score** (composite metric 0-100)
  - **Growth Trend** (MoM, YoY)
  - **Top Issues** (last 7 days)
  - **Recommendations** (AI-generated insights)
  - **Export to PDF** (board-ready report)

### AC5: Custom Date Ranges
- **GIVEN** jakÃ½koli report dashboard
- **WHEN** vyberu custom date range
- **THEN** data se pÅ™epoÄÃ­tajÃ­
- **AND** mohu srovnat s pÅ™edchozÃ­m obdobÃ­m
- **AND** vidÃ­m % zmÄ›nu

### AC6: Drill-Down Analysis
- **GIVEN** agregovanÃ¡ metrika (napÅ™. Total Revenue)
- **WHEN** kliknu na metriku
- **THEN** otevÅ™e se drill-down:
  - Revenue **by tenant**
  - Revenue **by plan**
  - Revenue **by month**
  - Revenue **by region**

---

## ðŸ—ï¸ Architecture

### Cube.js Schema
```javascript
// cube/schema/Revenue.js
cube(`Revenue`, {
  sql: `
    SELECT 
      t.id as tenant_id,
      s.amount,
      s.billing_cycle,
      s.created_at,
      t.plan_id
    FROM subscriptions s
    JOIN tenants t ON t.id = s.tenant_id
  `,
  
  measures: {
    mrr: {
      sql: `amount`,
      type: `sum`,
      filters: [{ sql: `${CUBE}.billing_cycle = 'monthly'` }]
    },
    
    arr: {
      sql: `amount * 12`,
      type: `sum`,
      filters: [{ sql: `${CUBE}.billing_cycle = 'annual'` }]
    },
    
    arpu: {
      sql: `amount / COUNT(DISTINCT ${CUBE}.tenant_id)`,
      type: `number`
    }
  },
  
  dimensions: {
    tenantId: {
      sql: `tenant_id`,
      type: `string`,
      primaryKey: true
    },
    
    createdAt: {
      sql: `created_at`,
      type: `time`
    }
  }
});

// cube/schema/Usage.js
cube(`Usage`, {
  sql: `
    SELECT 
      tenant_id,
      user_id,
      action,
      created_at
    FROM audit_logs
  `,
  
  measures: {
    dau: {
      sql: `user_id`,
      type: `countDistinct`,
      rollingWindow: {
        trailing: `1 day`
      }
    },
    
    mau: {
      sql: `user_id`,
      type: `countDistinct`,
      rollingWindow: {
        trailing: `30 day`
      }
    }
  }
});
```

### Frontend Integration
```tsx
import { useCubeQuery } from '@cubejs-client/react';

export const RevenueDashboard: React.FC = () => {
  const { resultSet, isLoading } = useCubeQuery({
    measures: ['Revenue.mrr', 'Revenue.arr', 'Revenue.arpu'],
    timeDimensions: [{
      dimension: 'Revenue.createdAt',
      granularity: 'month',
      dateRange: 'last 12 months'
    }],
    order: {
      'Revenue.createdAt': 'asc'
    }
  });
  
  if (isLoading) return <Loading />;
  
  const chartData = resultSet.tablePivot();
  
  return (
    <Grid container spacing={3}>
      <Grid item xs={12} md={4}>
        <MetricCard 
          title="MRR" 
          value={formatCurrency(chartData[0]['Revenue.mrr'])}
          trend="up"
          trendValue="+12%"
        />
      </Grid>
      
      <Grid item xs={12}>
        <LineChart
          data={chartData}
          xField="Revenue.createdAt"
          yField="Revenue.mrr"
          title="Monthly Recurring Revenue"
        />
      </Grid>
    </Grid>
  );
};
```

---

## ðŸ“¦ Implementation Tasks

### T1: Cube.js Schema Definition (~6h, ~600 LOC)
**Objective:** Definovat Cube.js data models

**Files:**
- `cube/schema/Revenue.js`
- `cube/schema/Usage.js`
- `cube/schema/Compliance.js`
- `cube/schema/Tenants.js`
- `cube/schema/Users.js`

**Cubes:**
- Revenue (MRR, ARR, ARPU, LTV)
- Usage (DAU, MAU, feature adoption)
- Compliance (audit logs, data retention)

**Acceptance:**
- Cube.js playground funguje
- VÅ¡echny measures validnÃ­
- Query performance < 1s

---

### T2: Revenue Dashboard (~4h, ~400 LOC)
**Objective:** Revenue metrics a trends

**Files:**
- `frontend/src/pages/admin/reports/RevenueDashboard.tsx`
- `frontend/src/hooks/useCubeRevenue.ts`

**Components:**
- MRR/ARR cards
- Revenue trend chart
- Churn rate gauge
- LTV cohort table

**Acceptance:**
- Dashboard loads < 2s
- Export to CSV/PDF works
- Date range filtering

---

### T3: Usage Reports Dashboard (~3h, ~300 LOC)
**Objective:** Usage analytics

**Files:**
- `frontend/src/pages/admin/reports/UsageDashboard.tsx`

**Metrics:**
- DAU/WAU/MAU
- Feature adoption
- Storage consumption
- API usage

**Acceptance:**
- Drill-down by tenant
- Export functionality
- Real-time updates (optional)

---

### T4: Compliance Dashboard (~3h, ~300 LOC)
**Objective:** Compliance reporting

**Files:**
- `frontend/src/pages/admin/reports/ComplianceDashboard.tsx`

**Reports:**
- Audit log coverage
- Data retention status
- Access control audit
- GDPR compliance

**Acceptance:**
- PDF export (board-ready)
- Historical comparison
- Alert on non-compliance

---

### T5: Executive Summary (~2h, ~200 LOC)
**Objective:** High-level KPI dashboard

**Files:**
- `frontend/src/pages/admin/reports/ExecutiveDashboard.tsx`

**Content:**
- Top 6 KPIs
- Health score
- Growth trends
- Recommendations

**Acceptance:**
- Single-page summary
- PDF export
- Shareable link

---

## ðŸŽ¯ Value Proposition

- **Data-Driven Decisions**: ObjektivnÃ­ metriky pro business rozhodnutÃ­
- **Executive Reporting**: Board-ready reports bez manuÃ¡lnÃ­ pÅ™Ã­pravy
- **Compliance**: AutomatickÃ© compliance tracking
- **Forecasting**: Revenue predictions

---

**Related:** [EPIC-003 README](../README.md#s9-reporting-dashboards)
