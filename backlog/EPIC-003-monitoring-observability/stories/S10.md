# S10: Real-Time Monitoring Widgets (Live Metrics)

**EPIC:** [EPIC-003: Monitoring & Observability](../README.md)  
**Status:** ğŸ”µ **TODO**  
**Priority:** P2  
**LOC:** ~1,200 Å™Ã¡dkÅ¯ (WebSocket + React widgets)  
**Effort:** ~12 hodin

---

## ğŸ“‹ Story Description

Jako **operations engineer / tenant admin**, chci **real-time monitoring widgets** zobrazujÃ­cÃ­ live metriky (active users, requests/sec, errors, health status), abych **vidÄ›l aktuÃ¡lnÃ­ stav systÃ©mu bez nutnosti manuÃ¡lnÃ­ho refresh**.

---

## ğŸ¯ Acceptance Criteria

### AC1: Live Metrics Widgets
- **GIVEN** dashboard s live widgets
- **WHEN** zobrazÃ­m strÃ¡nku
- **THEN** vidÃ­m **real-time** metriky (update kaÅ¾dÃ½ch 2-5s):
  - Active Users Now (WebSocket count)
  - Requests per Second (sliding window)
  - Error Rate (last 1 minute)
  - Response Time (p95, live)
  - Database Connections (current)
  - Queue Lag (Kafka consumer lag)

### AC2: System Health Status Widget
- **GIVEN** health status widget
- **WHEN** sluÅ¾ba je UP
- **THEN** zobrazÃ­ âœ… **HEALTHY** (green)
- **WHEN** sluÅ¾ba je DOWN
- **THEN** zobrazÃ­ âŒ **DOWN** (red)
- **AND** alarm sound (optional)
- **AND** desktop notification

### AC3: Live Activity Feed
- **GIVEN** activity feed widget
- **WHEN** user provede akci (login, create document, workflow)
- **THEN** akce se **okamÅ¾itÄ›** objevÃ­ ve feedu (WebSocket)
- **AND** fade-in animace
- **AND** max 50 poslednÃ­ch udÃ¡lostÃ­

### AC4: Mini Charts (Sparklines)
- **GIVEN** metric widget
- **WHEN** zobrazÃ­m metriku
- **THEN** vidÃ­m **mini trend chart** (last 5 min)
- **AND** current value (large font)
- **AND** % zmÄ›na (vs. 5 min ago)

### AC5: Alert Indicators
- **GIVEN** widget s thresholdem
- **WHEN** metrika pÅ™ekroÄÃ­ threshold (error rate > 5%)
- **THEN** widget **blikÃ¡** ÄervenÄ›
- **AND** zobrazÃ­ âš ï¸ ikonu
- **AND** desktop notification (optional)

---

## ğŸ—ï¸ Architecture

### Backend WebSocket
```java
@Component
public class LiveMetricsWebSocketHandler extends TextWebSocketHandler {
  
  private final Set<WebSocketSession> sessions = new CopyOnWriteArraySet<>();
  
  @Override
  public void afterConnectionEstablished(WebSocketSession session) {
    sessions.add(session);
  }
  
  @Scheduled(fixedRate = 2000) // every 2s
  public void broadcastMetrics() {
    var metrics = LiveMetricsDTO.builder()
      .timestamp(Instant.now())
      .activeUsers(sessionService.getActiveCount())
      .requestsPerSecond(metricsService.getRequestRate())
      .errorRate(metricsService.getErrorRate())
      .p95ResponseTime(metricsService.getP95Latency())
      .dbConnections(dataSource.getActiveConnections())
      .kafkaLag(kafkaConsumerService.getLag())
      .build();
    
    broadcast(toJson(metrics));
  }
  
  private void broadcast(String message) {
    sessions.forEach(session -> {
      try {
        session.sendMessage(new TextMessage(message));
      } catch (IOException e) {
        sessions.remove(session);
      }
    });
  }
}
```

### Frontend Hook
```tsx
export const useLiveMetrics = () => {
  const [metrics, setMetrics] = useState<LiveMetrics | null>(null);
  const [isConnected, setIsConnected] = useState(false);
  
  useEffect(() => {
    const ws = new WebSocket('ws://localhost:8080/ws/live-metrics');
    
    ws.onopen = () => setIsConnected(true);
    ws.onclose = () => setIsConnected(false);
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      setMetrics(data);
    };
    
    // Auto-reconnect
    ws.onerror = () => {
      setTimeout(() => ws.close(), 1000);
    };
    
    return () => ws.close();
  }, []);
  
  return { metrics, isConnected };
};
```

### Widget Component
```tsx
export const LiveMetricWidget: React.FC<{
  title: string;
  value: number;
  unit: string;
  threshold?: number;
  format?: (v: number) => string;
}> = ({ title, value, unit, threshold, format }) => {
  const isAlert = threshold && value > threshold;
  
  return (
    <Card sx={{ bgcolor: isAlert ? 'error.light' : 'background.paper' }}>
      <CardContent>
        <Typography variant="body2" color="text.secondary">
          {title}
        </Typography>
        
        <Box display="flex" alignItems="baseline">
          <Typography variant="h3" component="div">
            {format ? format(value) : value}
          </Typography>
          <Typography variant="body1" color="text.secondary" ml={1}>
            {unit}
          </Typography>
          {isAlert && <WarningIcon color="error" sx={{ ml: 1 }} />}
        </Box>
        
        <Sparkline data={recentValues} />
      </CardContent>
    </Card>
  );
};
```

---

## ğŸ“¦ Implementation Tasks

### T1: WebSocket Infrastructure (~4h, ~300 LOC)
**Files:**
- `backend/.../LiveMetricsWebSocketHandler.java`
- `backend/.../LiveMetricsDTO.java`

**Acceptance:**
- WebSocket `/ws/live-metrics` funguje
- Broadcast kaÅ¾dÃ½ch 2s
- Auto-reconnect on disconnect

---

### T2: Live Metrics Widgets (~4h, ~400 LOC)
**Files:**
- `frontend/src/components/monitoring/LiveMetricWidget.tsx`
- `frontend/src/components/monitoring/SystemHealthWidget.tsx`
- `frontend/src/hooks/useLiveMetrics.ts`

**Widgets:**
- Active Users
- Requests/sec
- Error Rate
- Response Time
- DB Connections
- Kafka Lag

**Acceptance:**
- Real-time updates (2s)
- Threshold alerts
- Sparklines

---

### T3: Activity Feed Widget (~2h, ~200 LOC)
**Files:**
- `frontend/src/components/monitoring/ActivityFeedWidget.tsx`

**Features:**
- WebSocket live events
- Fade-in animation
- Max 50 items
- Scroll virtualization

**Acceptance:**
- Events appear instantly
- Performance (no lag)

---

### T4: Alert Notifications (~2h, ~300 LOC)
**Files:**
- `frontend/src/utils/notifications.ts`

**Features:**
- Desktop notifications (Notification API)
- Sound alerts (optional)
- Threshold configuration

**Acceptance:**
- Permission request on first load
- Notifications work

---

## ğŸ¯ Example Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Live Monitoring Widgets                   â— Connected â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚  ğŸ‘¥ 87   â”‚ â”‚ ğŸ“¡ 523   â”‚ â”‚ âš ï¸ 2.3%  â”‚ â”‚ âš¡ 145ms â”‚  â”‚
â”‚ â”‚ Active   â”‚ â”‚ Req/sec  â”‚ â”‚ Errors   â”‚ â”‚ p95      â”‚  â”‚
â”‚ â”‚ Users    â”‚ â”‚ â–‚â–„â–…â–‡     â”‚ â”‚ â–â–‚â–ƒâ–…     â”‚ â”‚ â–ƒâ–„â–…â–ƒ     â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ System Health                                          â”‚
â”‚ âœ… Backend    âœ… Database   âœ… Redis    âœ… Kafka      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Live Activity Feed                                     â”‚
â”‚ â€¢ john@example.com logged in                 (now)     â”‚
â”‚ â€¢ Document "Report Q3" created              (5s ago)   â”‚
â”‚ â€¢ Workflow "Invoice Processing" started     (12s ago)  â”‚
â”‚ â€¢ jane@example.com uploaded file            (23s ago)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Related:** [EPIC-003 README](../README.md#s10-real-time-monitoring-widgets)
