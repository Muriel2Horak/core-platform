# TF-007: Test Data Management

**Epic:** [EPIC-002: Testing Infrastructure & Framework](../README.md)  
**Priority:** üî¥ P0 (Critical - Security)  
**Status:** üîµ TODO  
**Effort:** ~14 hodin  
**LOC:** ~1,200 ≈ô√°dk≈Ø

---

## üéØ User Story

**As a** Developer  
**I want** automatick√Ω syst√©m pro vytv√°≈ôen√≠ a maz√°n√≠ testovac√≠ch dat (users, tenants, roles)  
**So that** testy maj√≠ konzistentn√≠ data **A NIKDY se nedostanou do produkce**

---

## üö® Critical Security Requirements

### ‚ùå ZAK√ÅZ√ÅNO: Test Data v Produkci

**D≈Øvody:**
1. **Security Risk**: Test u≈æivatel√© s zn√°m√Ωmi hesly (`Test.1234`)
2. **Data Leak**: Test tenanti s fake daty mohou obsahovat sensitive info
3. **Compliance**: GDPR audit fail (test emails v production DB)
4. **Reputation**: Z√°kazn√≠k vid√≠ `test_user_123` v user listu

### ‚úÖ POVINN√â: Production Safety Guards

```
üîí Defense in Depth (4 layers):
‚îú‚îÄ‚îÄ Layer 1: @Profile("!production") - k√≥d se NEspust√≠ v produkci
‚îú‚îÄ‚îÄ Layer 2: Startup Check - fail fast pokud test data detected
‚îú‚îÄ‚îÄ Layer 3: DB Triggers - REJECT INSERT pokud username LIKE 'test_%'
‚îî‚îÄ‚îÄ Layer 4: Pre-commit Hook - BLOCK commit pokud hardcoded test data
```

---

## üìã Requirements

### Test Data Types

| Type | Prefix | Example | Cleanup Strategy |
|------|--------|---------|------------------|
| **E2E Users** | `e2e_*` | `e2e_login_user`, `e2e_admin` | After E2E test suite |
| **Integration Users** | `test_*` | `test_user_123` | After each test (`@AfterEach`) |
| **Tenants** | `test_tenant_*` | `test_tenant_alpha` | After each test |
| **Roles** | `test_role_*` | `test_role_custom` | After each test |
| **Permissions** | `test_perm_*` | `test_perm_special` | After each test |

### Naming Convention

```java
// ‚úÖ SPR√ÅVNƒö - v≈ædy prefix
createUser("test_admin", "test-admin@example.com");
createUser("e2e_login_user", "e2e@example.com");
createTenant("test_tenant_alpha");

// ‚ùå ≈†PATNƒö - bez prefixu
createUser("admin", "admin@example.com");  // M≈Ø≈æe b√Ωt v produkci!
createTenant("alpha_corp");                // Vypad√° jako real data!
```

---

## üíª Implementation Tasks

### Task Breakdown (7 tasks)

| Task | Description | LOC | Effort |
|------|-------------|-----|--------|
| **T1** | Test Data Seeder (Environment-Aware) | ~200 | 3h |
| **T2** | Production Safety Guards | ~150 | 2h |
| **T3** | Database Triggers (Block Test Data) | ~100 | 2h |
| **T4** | Test Data Cleanup (@AfterEach) | ~150 | 2h |
| **T5** | Test Data Builders | ~200 | 2h |
| **T6** | E2E Test Data Helpers (Playwright) | ~200 | 2h |
| **T7** | Test Data API (Dev/Test Only) | ~200 | 2h |

**Total**: ~1,200 LOC, ~15 hodin

---

## üì¶ T1: Test Data Seeder (Environment-Aware)

**Objective**: Automatick√© seedov√°n√≠ test dat p≈ôi startu (POUZE dev/test environment)

### Implementation

**File:** `backend/src/test-data/java/cz/muriel/core/testdata/TestDataSeeder.java`

```java
package cz.muriel.core.testdata;

import cz.muriel.core.user.model.User;
import cz.muriel.core.user.model.Role;
import cz.muriel.core.tenant.model.Tenant;
import cz.muriel.core.tenant.model.TenantType;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Profile;
import org.springframework.core.env.Environment;
import org.springframework.stereotype.Component;

import jakarta.annotation.PostConstruct;
import java.util.List;

/**
 * Seeds test data for development and test environments
 * 
 * CRITICAL: NEVER runs in production (@Profile annotation)
 */
@Component
@Profile("!production") // ‚ùå NEVER run in production
@RequiredArgsConstructor
@Slf4j
public class TestDataSeeder {
    
    private final UserService userService;
    private final TenantService tenantService;
    private final RoleService roleService;
    private final Environment environment;
    
    @PostConstruct
    public void seed() {
        // Double-check we're not in production
        if (isProdEnvironment()) {
            log.error("‚ùå CRITICAL: Test data seeder attempted to run in PRODUCTION!");
            throw new IllegalStateException(
                "Test data seeder is disabled in production. This is a configuration error!"
            );
        }
        
        String activeProfile = environment.getProperty("spring.profiles.active", "default");
        log.info("üå± Seeding test data for environment: {}", activeProfile);
        
        seedTestUsers();
        seedTestTenants();
        seedTestRoles();
        
        log.info("‚úÖ Test data seeding complete");
    }
    
    /**
     * Check if running in production environment
     */
    private boolean isProdEnvironment() {
        String[] activeProfiles = environment.getActiveProfiles();
        return List.of(activeProfiles).contains("production") || 
               List.of(activeProfiles).contains("prod");
    }
    
    /**
     * Seed test users (E2E + Integration)
     */
    private void seedTestUsers() {
        log.info("Creating test users...");
        
        // E2E users (persistent across test runs)
        createUser("e2e_admin", "e2e-admin@example.com", "Test.1234", Role.ADMIN);
        createUser("e2e_user", "e2e-user@example.com", "Test.1234", Role.USER);
        createUser("e2e_guest", "e2e-guest@example.com", "Test.1234", Role.GUEST);
        
        // Integration test users (cleaned up after each test)
        createUser("test_admin", "test-admin@example.com", "Test.1234", Role.ADMIN);
        createUser("test_user", "test-user@example.com", "Test.1234", Role.USER);
        
        log.info("‚úÖ Created {} test users", 5);
    }
    
    /**
     * Seed test tenants
     */
    private void seedTestTenants() {
        log.info("Creating test tenants...");
        
        createTenant("test_tenant_alpha", TenantType.STANDARD);
        createTenant("test_tenant_beta", TenantType.PREMIUM);
        createTenant("test_tenant_gamma", TenantType.ENTERPRISE);
        
        log.info("‚úÖ Created {} test tenants", 3);
    }
    
    /**
     * Seed test roles
     */
    private void seedTestRoles() {
        log.info("Creating test roles...");
        
        createRole("test_role_custom", Permission.READ, Permission.WRITE);
        createRole("test_role_readonly", Permission.READ);
        
        log.info("‚úÖ Created {} test roles", 2);
    }
    
    /**
     * Create user if not exists
     */
    private void createUser(String username, String email, String password, Role role) {
        if (userService.existsByUsername(username)) {
            log.debug("User {} already exists, skipping", username);
            return;
        }
        
        User user = User.builder()
            .username(username)
            .email(email)
            .password(passwordEncoder.encode(password))
            .role(role)
            .enabled(true)
            .build();
        
        userService.create(user);
        log.debug("Created user: {}", username);
    }
    
    private void createTenant(String name, TenantType type) {
        if (tenantService.existsByName(name)) {
            log.debug("Tenant {} already exists, skipping", name);
            return;
        }
        
        Tenant tenant = Tenant.builder()
            .name(name)
            .type(type)
            .active(true)
            .build();
        
        tenantService.create(tenant);
        log.debug("Created tenant: {}", name);
    }
    
    private void createRole(String name, Permission... permissions) {
        if (roleService.existsByName(name)) {
            log.debug("Role {} already exists, skipping", name);
            return;
        }
        
        Role role = Role.builder()
            .name(name)
            .permissions(Set.of(permissions))
            .build();
        
        roleService.create(role);
        log.debug("Created role: {}", name);
    }
}
```

### Configuration

**File:** `backend/src/main/resources/application-test.yml`

```yaml
spring:
  profiles:
    active: test

# Enable test data seeding
testdata:
  seed-on-startup: true
```

**File:** `backend/src/main/resources/application-production.yml`

```yaml
spring:
  profiles:
    active: production

# CRITICAL: Explicitly disable test data
testdata:
  seed-on-startup: false
```

---

## üîí T2: Production Safety Guards

**Objective**: Fail-fast startup checks + runtime validation

### Implementation

**File:** `backend/src/main/java/cz/muriel/core/config/ProductionSafetyConfig.java`

```java
package cz.muriel.core.config;

import cz.muriel.core.user.repository.UserRepository;
import cz.muriel.core.tenant.repository.TenantRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

/**
 * Production safety checks to prevent test data leakage
 */
@Configuration
@Slf4j
@RequiredArgsConstructor
public class ProductionSafetyConfig {
    
    /**
     * CRITICAL: Run safety checks on production startup
     * 
     * Checks for:
     * - Test users (username starts with 'test_' or 'e2e_')
     * - Test tenants (name starts with 'test_')
     * - Test roles (name starts with 'test_')
     * 
     * FAILS STARTUP if any test data found!
     */
    @Bean
    @ConditionalOnProperty(
        name = "spring.profiles.active", 
        havingValue = "production"
    )
    public CommandLineRunner productionSafetyCheck(
            UserRepository userRepository,
            TenantRepository tenantRepository,
            RoleRepository roleRepository
    ) {
        return args -> {
            log.info("üîí Running production safety checks...");
            
            // Check for test users
            List<User> testUsers = userRepository.findByUsernameStartingWithIgnoreCase("test_");
            List<User> e2eUsers = userRepository.findByUsernameStartingWithIgnoreCase("e2e_");
            
            int totalTestUsers = testUsers.size() + e2eUsers.size();
            if (totalTestUsers > 0) {
                log.error("‚ùå CRITICAL: {} test users found in PRODUCTION!", totalTestUsers);
                log.error("Test users: {}", testUsers.stream()
                    .map(User::getUsername)
                    .toList());
                log.error("E2E users: {}", e2eUsers.stream()
                    .map(User::getUsername)
                    .toList());
                
                throw new IllegalStateException(
                    String.format(
                        "Test data detected in production! Found %d test users. " +
                        "Application startup aborted for security reasons.",
                        totalTestUsers
                    )
                );
            }
            
            // Check for test tenants
            List<Tenant> testTenants = tenantRepository.findByNameStartingWithIgnoreCase("test_");
            if (!testTenants.isEmpty()) {
                log.error("‚ùå CRITICAL: {} test tenants found in PRODUCTION!", testTenants.size());
                log.error("Test tenants: {}", testTenants.stream()
                    .map(Tenant::getName)
                    .toList());
                
                throw new IllegalStateException(
                    String.format(
                        "Test data detected in production! Found %d test tenants. " +
                        "Application startup aborted.",
                        testTenants.size()
                    )
                );
            }
            
            // Check for test roles
            List<Role> testRoles = roleRepository.findByNameStartingWithIgnoreCase("test_");
            if (!testRoles.isEmpty()) {
                log.error("‚ùå CRITICAL: {} test roles found in PRODUCTION!", testRoles.size());
                throw new IllegalStateException("Test roles detected in production!");
            }
            
            log.info("‚úÖ Production safety check PASSED - No test data found");
        };
    }
}
```

### Repository Queries

**File:** `backend/src/main/java/cz/muriel/core/user/repository/UserRepository.java`

```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    
    // Existing methods...
    
    /**
     * Find all users with username starting with prefix (case-insensitive)
     * Used for production safety checks
     */
    List<User> findByUsernameStartingWithIgnoreCase(String prefix);
    
    /**
     * Delete all users with username starting with prefix
     * Used for test cleanup
     */
    @Modifying
    @Transactional
    void deleteByUsernameStartingWithIgnoreCase(String prefix);
}
```

---

## üõ°Ô∏è T3: Database Triggers (Block Test Data)

**Objective**: Database-level safety net (posledn√≠ obrana)

### Implementation

**File:** `backend/src/main/resources/db/migration/V998__test_data_constraints.sql`

```sql
-- ============================================================================
-- PRODUCTION SAFETY: Database Triggers to Prevent Test Data
-- ============================================================================
-- These triggers REJECT any INSERT/UPDATE of test data in production
-- 
-- How it works:
-- 1. Set app.environment config parameter on startup
-- 2. Trigger checks environment before INSERT/UPDATE
-- 3. REJECT if environment = 'production' AND data looks like test data
-- ============================================================================

-- Function to check if we're in production environment
CREATE OR REPLACE FUNCTION is_production_environment()
RETURNS BOOLEAN AS $$
BEGIN
    RETURN current_setting('app.environment', true) = 'production';
EXCEPTION
    WHEN OTHERS THEN
        -- Default to safe mode (assume production if setting not found)
        RETURN true;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- ============================================================================
-- TRIGGER 1: Prevent Test Users
-- ============================================================================
CREATE OR REPLACE FUNCTION prevent_test_users_in_production()
RETURNS TRIGGER AS $$
BEGIN
    -- Only check in production
    IF is_production_environment() THEN
        -- Check for test_ or e2e_ prefix
        IF NEW.username ILIKE 'test_%' OR NEW.username ILIKE 'e2e_%' THEN
            RAISE EXCEPTION '‚ùå SECURITY: Test users (username: %) are not allowed in production environment!', NEW.username
                USING HINT = 'Remove test data before deploying to production',
                      ERRCODE = 'check_violation';
        END IF;
        
        -- Check for test email domains
        IF NEW.email ILIKE '%@example.com' OR NEW.email ILIKE 'test-%@%' OR NEW.email ILIKE 'e2e-%@%' THEN
            RAISE EXCEPTION '‚ùå SECURITY: Test emails (email: %) are not allowed in production environment!', NEW.email
                USING HINT = 'Use real email addresses in production',
                      ERRCODE = 'check_violation';
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER check_test_users_before_insert
    BEFORE INSERT OR UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION prevent_test_users_in_production();

-- ============================================================================
-- TRIGGER 2: Prevent Test Tenants
-- ============================================================================
CREATE OR REPLACE FUNCTION prevent_test_tenants_in_production()
RETURNS TRIGGER AS $$
BEGIN
    IF is_production_environment() THEN
        IF NEW.name ILIKE 'test_%' OR NEW.name ILIKE 'test %' THEN
            RAISE EXCEPTION '‚ùå SECURITY: Test tenants (name: %) are not allowed in production environment!', NEW.name
                USING HINT = 'Remove test data before deploying to production',
                      ERRCODE = 'check_violation';
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER check_test_tenants_before_insert
    BEFORE INSERT OR UPDATE ON tenants
    FOR EACH ROW
    EXECUTE FUNCTION prevent_test_tenants_in_production();

-- ============================================================================
-- TRIGGER 3: Prevent Test Roles
-- ============================================================================
CREATE OR REPLACE FUNCTION prevent_test_roles_in_production()
RETURNS TRIGGER AS $$
BEGIN
    IF is_production_environment() THEN
        IF NEW.name ILIKE 'test_%' THEN
            RAISE EXCEPTION '‚ùå SECURITY: Test roles (name: %) are not allowed in production environment!', NEW.name
                USING HINT = 'Remove test data before deploying to production',
                      ERRCODE = 'check_violation';
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER check_test_roles_before_insert
    BEFORE INSERT OR UPDATE ON roles
    FOR EACH ROW
    EXECUTE FUNCTION prevent_test_roles_in_production();

-- ============================================================================
-- Comments for Documentation
-- ============================================================================
COMMENT ON FUNCTION prevent_test_users_in_production() IS 
    'Production safety trigger: Prevents insertion of test users (username starting with test_ or e2e_)';

COMMENT ON FUNCTION prevent_test_tenants_in_production() IS 
    'Production safety trigger: Prevents insertion of test tenants (name starting with test_)';

COMMENT ON FUNCTION prevent_test_roles_in_production() IS 
    'Production safety trigger: Prevents insertion of test roles (name starting with test_)';
```

### Set Environment Parameter on Startup

**File:** `backend/src/main/java/cz/muriel/core/config/DatabaseConfig.java`

```java
@Configuration
public class DatabaseConfig {
    
    @Bean
    public CommandLineRunner setDatabaseEnvironment(
            DataSource dataSource,
            Environment environment
    ) {
        return args -> {
            String activeProfile = environment.getProperty("spring.profiles.active", "dev");
            
            try (Connection conn = dataSource.getConnection()) {
                // Set PostgreSQL session variable
                conn.createStatement().execute(
                    String.format("SET app.environment = '%s'", activeProfile)
                );
                
                log.info("‚úÖ Set database environment to: {}", activeProfile);
            }
        };
    }
}
```

---

## üßπ T4: Test Data Cleanup (@AfterEach)

**Objective**: Automatick√© maz√°n√≠ test dat po ka≈æd√©m integration testu

### Implementation

**File:** `backend/src/integration-test/java/cz/muriel/core/testutil/TestDataManager.java`

```java
package cz.muriel.core.testutil;

import cz.muriel.core.user.repository.UserRepository;
import cz.muriel.core.tenant.repository.TenantRepository;
import cz.muriel.core.role.repository.RoleRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

/**
 * Manages test data lifecycle (create, cleanup)
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class TestDataManager {
    
    private final UserRepository userRepository;
    private final TenantRepository tenantRepository;
    private final RoleRepository roleRepository;
    
    /**
     * Delete all test users (username starts with 'test_' or 'e2e_')
     */
    @Transactional
    public void deleteAllTestUsers() {
        int deletedTest = userRepository.deleteByUsernameStartingWithIgnoreCase("test_");
        int deletedE2e = userRepository.deleteByUsernameStartingWithIgnoreCase("e2e_");
        
        log.debug("Cleaned up {} test users and {} e2e users", deletedTest, deletedE2e);
    }
    
    /**
     * Delete all test tenants
     */
    @Transactional
    public void deleteAllTestTenants() {
        int deleted = tenantRepository.deleteByNameStartingWithIgnoreCase("test_");
        log.debug("Cleaned up {} test tenants", deleted);
    }
    
    /**
     * Delete all test roles
     */
    @Transactional
    public void deleteAllTestRoles() {
        int deleted = roleRepository.deleteByNameStartingWithIgnoreCase("test_");
        log.debug("Cleaned up {} test roles", deleted);
    }
    
    /**
     * Delete ALL test data (users + tenants + roles)
     */
    @Transactional
    public void cleanupAll() {
        deleteAllTestUsers();
        deleteAllTestTenants();
        deleteAllTestRoles();
        
        log.info("‚úÖ All test data cleaned up");
    }
}
```

**File:** `backend/src/integration-test/java/cz/muriel/core/BaseIntegrationTest.java`

```java
package cz.muriel.core;

import cz.muriel.core.testutil.TestDataManager;
import org.junit.jupiter.api.AfterEach;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.transaction.annotation.Transactional;

/**
 * Base class for all integration tests
 * 
 * Provides:
 * - Automatic test data cleanup (@AfterEach)
 * - TestDataManager for creating test data
 * - Transactional rollback support
 */
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@Transactional
public abstract class BaseIntegrationTest {
    
    @Autowired
    protected TestDataManager testDataManager;
    
    /**
     * CRITICAL: Clean up test data after EACH test
     * Ensures test isolation and prevents data pollution
     */
    @AfterEach
    void cleanupTestData() {
        testDataManager.cleanupAll();
    }
}
```

---

## üèóÔ∏è T5: Test Data Builders

**Objective**: Fluent API pro vytv√°≈ôen√≠ test dat

### Implementation

**File:** `backend/src/integration-test/java/cz/muriel/core/testutil/TestDataBuilder.java`

```java
package cz.muriel.core.testutil;

import cz.muriel.core.user.model.User;
import cz.muriel.core.user.model.Role;
import cz.muriel.core.tenant.model.Tenant;
import cz.muriel.core.tenant.model.TenantType;

import java.util.Set;
import java.util.UUID;

/**
 * Fluent builders for test data
 * 
 * Usage:
 * User user = TestDataBuilder.testUser().build();
 * Tenant tenant = TestDataBuilder.testTenant("alpha").build();
 */
public class TestDataBuilder {
    
    /**
     * Create test user with random username
     */
    public static UserBuilder testUser() {
        String randomId = UUID.randomUUID().toString().substring(0, 8);
        return User.builder()
            .username("test_user_" + randomId)
            .email("test-" + randomId + "@example.com")
            .password("Test.1234")
            .role(Role.USER)
            .enabled(true);
    }
    
    /**
     * Create test admin user
     */
    public static UserBuilder testAdmin() {
        String randomId = UUID.randomUUID().toString().substring(0, 8);
        return User.builder()
            .username("test_admin_" + randomId)
            .email("test-admin-" + randomId + "@example.com")
            .password("Test.1234")
            .role(Role.ADMIN)
            .enabled(true);
    }
    
    /**
     * Create E2E test user (persistent across test runs)
     */
    public static UserBuilder e2eUser(String username) {
        return User.builder()
            .username("e2e_" + username)
            .email("e2e-" + username + "@example.com")
            .password("Test.1234")
            .role(Role.USER)
            .enabled(true);
    }
    
    /**
     * Create test tenant
     */
    public static TenantBuilder testTenant(String name) {
        return Tenant.builder()
            .name("test_tenant_" + name)
            .type(TenantType.STANDARD)
            .active(true);
    }
    
    /**
     * Create test role
     */
    public static RoleBuilder testRole(String name, Permission... permissions) {
        return Role.builder()
            .name("test_role_" + name)
            .permissions(Set.of(permissions));
    }
}
```

### Usage Example

```java
@Test
void shouldCreateUser() {
    // ARRANGE
    User user = TestDataBuilder.testUser()
        .username("test_john")
        .email("test-john@example.com")
        .role(Role.ADMIN)
        .build();
    
    // ACT
    User created = userService.create(user);
    
    // ASSERT
    assertThat(created.getId()).isNotNull();
    assertThat(created.getRole()).isEqualTo(Role.ADMIN);
}
```

---

## üé≠ T6: E2E Test Data Helpers (Playwright)

**Objective**: Playwright helpers pro vytv√°≈ôen√≠ test dat

### Implementation

**File:** `e2e/helpers/test-data.ts`

```typescript
/**
 * E2E Test Data Helpers
 * 
 * Creates test data via backend API for E2E tests
 * All data prefixed with 'e2e_' to prevent production leakage
 */

interface User {
  id: string;
  username: string;
  email: string;
  role: string;
}

interface Tenant {
  id: string;
  name: string;
  type: string;
}

export class TestDataHelper {
  private static readonly API_BASE = process.env.API_BASE || 'http://localhost:8080';
  
  /**
   * Create E2E test user
   * IMPORTANT: Username is automatically prefixed with 'e2e_'
   */
  static async createUser(
    username: string, 
    email: string, 
    role: 'ADMIN' | 'USER' | 'GUEST' = 'USER'
  ): Promise<User> {
    const response = await fetch(`${this.API_BASE}/api/test-data/users`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: `e2e_${username}`, // Auto-prefix
        email: `e2e-${email}`,        // Auto-prefix
        password: 'Test.1234',
        role: role
      })
    });
    
    if (!response.ok) {
      throw new Error(`Failed to create test user: ${response.statusText}`);
    }
    
    return response.json();
  }
  
  /**
   * Create E2E test tenant
   */
  static async createTenant(
    name: string, 
    type: 'STANDARD' | 'PREMIUM' | 'ENTERPRISE' = 'STANDARD'
  ): Promise<Tenant> {
    const response = await fetch(`${this.API_BASE}/api/test-data/tenants`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: `test_tenant_${name}`,
        type: type
      })
    });
    
    if (!response.ok) {
      throw new Error(`Failed to create test tenant: ${response.statusText}`);
    }
    
    return response.json();
  }
  
  /**
   * Cleanup ALL E2E test data
   * Call this after test suite completes
   */
  static async cleanup(): Promise<void> {
    const response = await fetch(`${this.API_BASE}/api/test-data/cleanup`, {
      method: 'DELETE'
    });
    
    if (!response.ok) {
      console.error('Failed to cleanup test data:', response.statusText);
    } else {
      console.log('‚úÖ Test data cleaned up');
    }
  }
  
  /**
   * Seed default E2E users (admin, user, guest)
   */
  static async seedDefaultUsers(): Promise<void> {
    await this.createUser('admin', 'admin@example.com', 'ADMIN');
    await this.createUser('user', 'user@example.com', 'USER');
    await this.createUser('guest', 'guest@example.com', 'GUEST');
  }
}
```

### Usage in E2E Tests

**File:** `e2e/specs/post/users/user-management.spec.ts`

```typescript
import { test, expect } from '@playwright/test';
import { TestDataHelper } from '../../../helpers/test-data';

test.describe('User Management @CORE-456', () => {
  
  test.beforeAll(async () => {
    // Seed test data before tests
    await TestDataHelper.seedDefaultUsers();
  });
  
  test.afterAll(async () => {
    // Cleanup after all tests
    await TestDataHelper.cleanup();
  });
  
  test('should create new user @E2E-USER-001', async ({ page }) => {
    // ARRANGE: Create test admin user
    const admin = await TestDataHelper.createUser('test_admin', 'admin@example.com', 'ADMIN');
    
    // ACT: Login and create user via UI
    await page.goto('/login');
    await page.fill('[name="username"]', admin.username);
    await page.fill('[name="password"]', 'Test.1234');
    await page.click('button[type="submit"]');
    
    await page.goto('/users/new');
    await page.fill('[name="username"]', 'newuser');
    await page.fill('[name="email"]', 'newuser@example.com');
    await page.click('button[type="submit"]');
    
    // ASSERT: User created
    await expect(page.locator('.success-message')).toBeVisible();
  });
});
```

---

## üåê T7: Test Data API (Dev/Test Only)

**Objective**: REST API pro vytv√°≈ôen√≠ test dat (POUZE dev/test environment)

### Implementation

**File:** `backend/src/test-data/java/cz/muriel/core/testdata/TestDataController.java`

```java
package cz.muriel.core.testdata;

import cz.muriel.core.user.dto.CreateUserRequest;
import cz.muriel.core.user.model.User;
import cz.muriel.core.tenant.dto.CreateTenantRequest;
import cz.muriel.core.tenant.model.Tenant;
import cz.muriel.core.testutil.TestDataManager;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Profile;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;

/**
 * Test Data API - ONLY available in dev/test environments
 * 
 * Endpoints:
 * - POST /api/test-data/users - Create test user
 * - POST /api/test-data/tenants - Create test tenant
 * - POST /api/test-data/seed - Seed all test data
 * - DELETE /api/test-data/cleanup - Delete all test data
 * 
 * CRITICAL: This controller is DISABLED in production (@Profile)
 */
@RestController
@RequestMapping("/api/test-data")
@Profile("!production") // ‚ùå NEVER available in production
@RequiredArgsConstructor
@Slf4j
public class TestDataController {
    
    private final UserService userService;
    private final TenantService tenantService;
    private final TestDataSeeder testDataSeeder;
    private final TestDataManager testDataManager;
    
    /**
     * Create test user
     * 
     * IMPORTANT: Username MUST start with 'test_' or 'e2e_'
     */
    @PostMapping("/users")
    public ResponseEntity<User> createTestUser(@Valid @RequestBody CreateUserRequest request) {
        validateTestPrefix(request.getUsername(), "username");
        validateTestEmail(request.getEmail());
        
        User user = userService.createUser(request);
        log.info("Created test user: {}", user.getUsername());
        
        return ResponseEntity.ok(user);
    }
    
    /**
     * Create test tenant
     */
    @PostMapping("/tenants")
    public ResponseEntity<Tenant> createTestTenant(@Valid @RequestBody CreateTenantRequest request) {
        validateTestPrefix(request.getName(), "tenant name");
        
        Tenant tenant = tenantService.createTenant(request);
        log.info("Created test tenant: {}", tenant.getName());
        
        return ResponseEntity.ok(tenant);
    }
    
    /**
     * Seed all default test data
     */
    @PostMapping("/seed")
    public ResponseEntity<Void> seed() {
        log.info("Manually triggering test data seed");
        testDataSeeder.seed();
        return ResponseEntity.ok().build();
    }
    
    /**
     * Cleanup all test data
     */
    @DeleteMapping("/cleanup")
    public ResponseEntity<Void> cleanup() {
        log.info("Cleaning up all test data");
        testDataManager.cleanupAll();
        return ResponseEntity.ok().build();
    }
    
    /**
     * Validate that value starts with 'test_' or 'e2e_'
     */
    private void validateTestPrefix(String value, String fieldName) {
        if (!value.startsWith("test_") && !value.startsWith("e2e_")) {
            throw new IllegalArgumentException(
                String.format(
                    "%s must start with 'test_' or 'e2e_' (got: %s). " +
                    "This ensures test data doesn't leak to production.",
                    fieldName, value
                )
            );
        }
    }
    
    /**
     * Validate that email is test email
     */
    private void validateTestEmail(String email) {
        if (!email.contains("@example.com") && !email.startsWith("test-") && !email.startsWith("e2e-")) {
            throw new IllegalArgumentException(
                "Test emails must use @example.com domain or start with 'test-' or 'e2e-'"
            );
        }
    }
}
```

---

## ‚úÖ Acceptance Criteria

### Test Data Creation
- [ ] Test data seeder (@PostConstruct)
- [ ] Environment-aware seeding (@Profile("!production"))
- [ ] Test users created (e2e_admin, e2e_user, test_admin, test_user)
- [ ] Test tenants created (test_tenant_alpha, test_tenant_beta)
- [ ] Test roles created (test_role_custom, test_role_readonly)

### Production Safety
- [ ] Production safety startup check (fails if test data found)
- [ ] Database triggers (REJECT INSERT if test_ in production)
- [ ] @Profile("!production") on seeder and API controller
- [ ] Environment parameter set on DB connection

### Test Data Cleanup
- [ ] TestDataManager component
- [ ] @AfterEach cleanup in BaseIntegrationTest
- [ ] DELETE queries (deleteByUsernameStartingWith)
- [ ] Cleanup API endpoint (DELETE /api/test-data/cleanup)

### Test Data Builders
- [ ] TestDataBuilder utility class
- [ ] Fluent API (testUser(), testAdmin(), e2eUser())
- [ ] Random username generation (UUID)
- [ ] Auto-prefixing (test_, e2e_)

### E2E Helpers
- [ ] TestDataHelper class (Playwright)
- [ ] createUser() method (auto-prefix e2e_)
- [ ] createTenant() method
- [ ] cleanup() method
- [ ] seedDefaultUsers() method

### Test Data API
- [ ] TestDataController (@Profile("!production"))
- [ ] POST /api/test-data/users
- [ ] POST /api/test-data/tenants
- [ ] POST /api/test-data/seed
- [ ] DELETE /api/test-data/cleanup
- [ ] Validation (username must start with test_ or e2e_)

---

## üéØ Definition of Done

- [ ] All 7 tasks implemented
- [ ] Test data seeder working (dev/test only)
- [ ] Production safety checks passing
- [ ] Database triggers installed
- [ ] Test data cleanup working
- [ ] Test data builders documented
- [ ] E2E helpers working in Playwright
- [ ] Test Data API endpoints working
- [ ] **VERIFIED**: No test data in production (manual check)
- [ ] Documentation updated (test data conventions)

---

## üìä Success Metrics

- ‚úÖ **0 test users** in production (verified by startup check)
- ‚úÖ **0 test tenants** in production
- ‚úÖ **0 test roles** in production
- ‚úÖ **100% test isolation** (each test cleans up after itself)
- ‚úÖ **<5s test data seeding** (fast startup)
- ‚úÖ **<1s cleanup per test** (@AfterEach)

---

## üîó Related Stories

- **TF-001**: Test Registry - uses test data in integration tests
- **TF-004**: CI/CD Quality Gates - runs tests with test data
- **TF-006**: Mock Services - mocks external services in tests

---

**Back to:** [EPIC-002: Testing Infrastructure](../README.md)
