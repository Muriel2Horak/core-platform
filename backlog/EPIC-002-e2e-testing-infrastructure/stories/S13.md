# TF-006: Mock Services for Integration Testing

**Epic:** [EPIC-002: Testing Infrastructure & Framework](../README.md)  
**Priority:** P1 (Foundation)  
**Status:** ğŸ”µ TODO  
**Effort:** ~10 hodin  
**LOC:** ~800 Å™Ã¡dkÅ¯

---

## ğŸ“‹ User Story

**As a** Developer  
**I want** mock servery pro externÃ­ sluÅ¾by v testech  
**So that** mÅ¯Å¾u testovat integraci bez zÃ¡vislosti na reÃ¡lnÃ½ch sluÅ¾bÃ¡ch

---

## ğŸ¯ Objectives

### ProÄ MockovÃ¡nÃ­?

1. **Rychlost**: Mock server odpovÃ­dÃ¡ okamÅ¾itÄ› (ne 5s na Keycloak token)
2. **Spolehlivost**: Testy nepadajÃ­ kvÅ¯li vÃ½padku externÃ­ sluÅ¾by
3. **Testovatelnost**: MÅ¯Å¾eÅ¡ simulovat edge cases (timeout, 500 error, atd.)
4. **Izolace**: Unit testy testujÃ­ TVÅ®J kÃ³d, ne cizÃ­ API

### Co Mockovat?

| SluÅ¾ba | Kdy Mockovat | Kdy Real |
|--------|--------------|----------|
| **Keycloak** | Unit tests, rychlÃ© integration tests | E2E tests |
| **MinIO (S3)** | Unit tests (upload/download) | E2E tests |
| **Cube.js** | Unit tests (reporting API) | E2E tests |
| **External APIs** | VÅ½DY (nemÃ¡me kontrolu) | NIKDY |
| **n8n Webhooks** | Integration tests | E2E tests |

---

## ğŸ—ï¸ Architecture

### Mock Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ E2E Tests (Playwright)                                  â”‚
â”‚ â†’ Real Services (Keycloak, MinIO, n8n)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Integration Tests (REST Assured + Testcontainers)      â”‚
â”‚ â†’ Mock Servers (WireMock) + Real DB/Kafka              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Unit Tests (JUnit + Mockito)                            â”‚
â”‚ â†’ Mocked Dependencies (@Mock)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» Implementation Tasks

### Task Breakdown (6 tasks)

| Task | Description | LOC | Effort |
|------|-------------|-----|--------|
| **T1** | WireMock Setup | ~100 | 2h |
| **T2** | Keycloak Mock Server | ~200 | 3h |
| **T3** | MinIO (S3) Mock | ~150 | 2h |
| **T4** | n8n Webhook Mock | ~150 | 2h |
| **T5** | External API Mocks | ~100 | 1h |
| **T6** | Mock Utilities & Helpers | ~100 | 2h |

**Total**: ~800 LOC, ~12 hodin

---

## ğŸ“¦ Implementation Details

### T1: WireMock Setup

**Dependency:**
```xml
<!-- backend/pom.xml -->
<dependency>
    <groupId>com.github.tomakehurst</groupId>
    <artifactId>wiremock-jre8-standalone</artifactId>
    <version>2.35.0</version>
    <scope>test</scope>
</dependency>
```

**Base Test Class:**
```java
// backend/src/integration-test/java/cz/muriel/core/BaseIntegrationTest.java
@SpringBootTest(webEnvironment = RANDOM_PORT)
@Testcontainers
public abstract class BaseIntegrationTest {
    
    @Container
    static WireMockContainer wireMock = new WireMockContainer("wiremock/wiremock:2.35.0")
        .withMappingFromResource("wiremock/keycloak-mappings.json")
        .withMappingFromResource("wiremock/minio-mappings.json");
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        // Override service URLs to point to WireMock
        registry.add("keycloak.admin.base-url", wireMock::getBaseUrl);
        registry.add("minio.endpoint", wireMock::getBaseUrl);
    }
}
```

---

### T2: Keycloak Mock Server

**Mock Token Endpoint:**
```json
// backend/src/integration-test/resources/wiremock/keycloak-mappings.json
{
  "mappings": [
    {
      "request": {
        "method": "POST",
        "urlPath": "/realms/admin/protocol/openid-connect/token"
      },
      "response": {
        "status": 200,
        "headers": {
          "Content-Type": "application/json"
        },
        "jsonBody": {
          "access_token": "mock-jwt-token-12345",
          "token_type": "Bearer",
          "expires_in": 300,
          "refresh_token": "mock-refresh-token"
        }
      }
    },
    {
      "request": {
        "method": "GET",
        "urlPath": "/admin/realms/admin/users",
        "headers": {
          "Authorization": {
            "matches": "Bearer mock-jwt-token-.*"
          }
        }
      },
      "response": {
        "status": 200,
        "jsonBody": [
          {
            "id": "user-123",
            "username": "testuser",
            "email": "test@example.com",
            "enabled": true
          }
        ]
      }
    }
  ]
}
```

**Test Example:**
```java
@Test
void shouldFetchUsersFromKeycloak() {
    // Given: WireMock mÃ¡ stub pro Keycloak
    
    // When: ZavolÃ¡Å¡ KeycloakAdminService
    List<User> users = keycloakAdminService.getUsers();
    
    // Then: DostaneÅ¡ mock data
    assertThat(users).hasSize(1);
    assertThat(users.get(0).getUsername()).isEqualTo("testuser");
}
```

---

### T3: MinIO (S3) Mock

**Mock S3 Upload:**
```json
{
  "request": {
    "method": "PUT",
    "urlPathPattern": "/bucket/.*"
  },
  "response": {
    "status": 200,
    "headers": {
      "ETag": "\"mock-etag-abc123\""
    }
  }
}
```

**Test Helper:**
```java
// backend/src/integration-test/java/cz/muriel/core/storage/MinioMockHelper.java
public class MinioMockHelper {
    
    public static void stubSuccessfulUpload(WireMockServer wireMock, String bucketName, String fileName) {
        wireMock.stubFor(
            put(urlEqualTo("/" + bucketName + "/" + fileName))
                .willReturn(aResponse()
                    .withStatus(200)
                    .withHeader("ETag", "\"mock-etag\""))
        );
    }
    
    public static void stubUploadFailure(WireMockServer wireMock, String bucketName) {
        wireMock.stubFor(
            put(urlMatching("/" + bucketName + "/.*"))
                .willReturn(aResponse()
                    .withStatus(500)
                    .withBody("Internal Server Error"))
        );
    }
}
```

---

### T4: n8n Webhook Mock

**Mock Webhook Receiver:**
```json
{
  "request": {
    "method": "POST",
    "urlPath": "/webhook/user-created"
  },
  "response": {
    "status": 200,
    "jsonBody": {
      "workflowId": "workflow-123",
      "executionId": "exec-456",
      "status": "success"
    }
  }
}
```

**Test Example:**
```java
@Test
void shouldTriggerN8nWebhookOnUserCreation() {
    // Given: WireMock stub pro n8n webhook
    wireMock.stubFor(
        post("/webhook/user-created")
            .withRequestBody(matchingJsonPath("$.userId"))
            .willReturn(ok())
    );
    
    // When: VytvoÅ™Ã­Å¡ usera
    userService.createUser("newuser", "new@example.com");
    
    // Then: Webhook byl zavolÃ¡n
    wireMock.verify(postRequestedFor(urlEqualTo("/webhook/user-created"))
        .withRequestBody(matchingJsonPath("$.userId", equalTo("newuser"))));
}
```

---

### T5: External API Mocks

**Generic REST Client Mock:**
```java
// backend/src/integration-test/java/cz/muriel/core/integration/ExternalApiMockHelper.java
public class ExternalApiMockHelper {
    
    /**
     * Mock external payment gateway
     */
    public static void stubPaymentSuccess(WireMockServer wireMock, String orderId, BigDecimal amount) {
        wireMock.stubFor(
            post("/api/v1/payments")
                .withRequestBody(matchingJsonPath("$.orderId", equalTo(orderId)))
                .willReturn(okJson("""
                    {
                        "transactionId": "txn-123",
                        "status": "approved",
                        "amount": %s
                    }
                    """.formatted(amount)))
        );
    }
    
    /**
     * Mock timeout scenario
     */
    public static void stubTimeout(WireMockServer wireMock, String url, int delayMs) {
        wireMock.stubFor(
            any(urlEqualTo(url))
                .willReturn(ok().withFixedDelay(delayMs))
        );
    }
}
```

---

### T6: Mock Utilities & Helpers

**Test Data Builders:**
```java
// backend/src/integration-test/java/cz/muriel/core/testutil/MockDataBuilder.java
public class MockDataBuilder {
    
    public static String keycloakToken() {
        return "mock-jwt-token-" + UUID.randomUUID();
    }
    
    public static String keycloakUserJson(String username, String email) {
        return """
            {
                "id": "%s",
                "username": "%s",
                "email": "%s",
                "enabled": true,
                "emailVerified": true
            }
            """.formatted(UUID.randomUUID(), username, email);
    }
    
    public static void stubKeycloakUserExists(WireMockServer wireMock, String userId) {
        wireMock.stubFor(
            get("/admin/realms/admin/users/" + userId)
                .willReturn(okJson(keycloakUserJson("user-" + userId, "user@example.com")))
        );
    }
}
```

---

## ğŸ§ª Testing Strategy

### Test Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ E2E Tests                                               â”‚
â”‚ â†’ Real Keycloak, Real MinIO, Real n8n                  â”‚
â”‚ â†’ Full stack integration                                â”‚
â”‚ â†’ Runtime: 20-30 min                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Integration Tests (WireMock)                            â”‚
â”‚ â†’ Mock Keycloak, Mock MinIO, Mock n8n                  â”‚
â”‚ â†’ Real PostgreSQL (Testcontainers)                     â”‚
â”‚ â†’ Runtime: 5-10 min                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Unit Tests (Mockito)                                    â”‚
â”‚ â†’ Mock everything (repositories, services)              â”‚
â”‚ â†’ Pure business logic testing                           â”‚
â”‚ â†’ Runtime: 1-2 min                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Acceptance Criteria

- [ ] WireMock Testcontainer setup
- [ ] Keycloak mock (token endpoint, user API)
- [ ] MinIO mock (upload, download, delete)
- [ ] n8n webhook mock
- [ ] External API mock helpers
- [ ] Test utilities & data builders
- [ ] Documentation (jak pouÅ¾Ã­t mocks)
- [ ] Example integration tests
- [ ] CI/CD integration

---

## ğŸ¯ Definition of Done

- [ ] All 6 tasks implemented
- [ ] Integration tests using mocks passing
- [ ] Mock helpers documented
- [ ] Example tests in codebase
- [ ] CI/CD runs integration tests with mocks
- [ ] <5 min runtime for integration test suite
- [ ] Code review approved
- [ ] Documentation updated

---

## ğŸ”— Related Stories

- **TF-001**: Test Registry - uses mocks in integration tests
- **TF-004**: CI/CD Quality Gates - runs integration tests with mocks
- **EPIC-011**: n8n Workflow - uses webhook mocks

---

## ğŸ“– Documentation Outline

### Testing Guide Update

```markdown
# Using Mocks in Integration Tests

## When to Mock?

- External services (Keycloak, MinIO)
- Third-party APIs (payment gateways, email providers)
- n8n webhooks
- Slow operations (>1s response time)

## When NOT to Mock?

- Your own backend services
- Database (use Testcontainers)
- Kafka, Redis (use Testcontainers)
- E2E tests (use real services)

## Example: Mocking Keycloak

```java
@Test
void shouldCreateUserWithKeycloakIntegration() {
    // Arrange: Stub Keycloak API
    wireMock.stubFor(
        post("/admin/realms/admin/users")
            .willReturn(created()
                .withHeader("Location", "/users/user-123"))
    );
    
    // Act: Create user
    User user = userService.createUser("testuser", "test@example.com");
    
    // Assert: User created + Keycloak called
    assertThat(user.getKeycloakId()).isEqualTo("user-123");
    wireMock.verify(postRequestedFor(urlEqualTo("/admin/realms/admin/users")));
}
```

## Mock Helpers

Use `MockDataBuilder` for common scenarios:
- `MockDataBuilder.stubKeycloakUserExists(wireMock, userId)`
- `MinioMockHelper.stubSuccessfulUpload(wireMock, bucket, file)`
- `ExternalApiMockHelper.stubPaymentSuccess(wireMock, orderId, amount)`
```

---

**Back to:** [EPIC-002: Testing Infrastructure](../README.md)
